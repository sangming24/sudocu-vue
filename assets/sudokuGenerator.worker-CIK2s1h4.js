(function(){"use strict";function m(o){for(let r=o.length-1;r>0;r--){const t=Math.floor(Math.random()*(r+1));[o[r],o[t]]=[o[t],o[r]]}return o}function v(o){return o.map(r=>r.slice())}function S(o,r,t,n){for(let i=0;i<9;i++)if(o[r][i]===n||o[i][t]===n)return!1;const e=Math.floor(r/3)*3,l=Math.floor(t/3)*3;for(let i=e;i<e+3;i++)for(let c=l;c<l+3;c++)if(o[i][c]===n)return!1;return!0}const y={NakedSingle:.1,HiddenSingle:.2,NakedPair:1,NakedTriple:1.4,Pointing:1.2,Claiming:1.3,XWing:2.5,SimpleColoring:3};function N(o,r,t){return{value:o,candidates:o?[]:[1,2,3,4,5,6,7,8,9],r,c:t}}function M(o){const r=o.map((t,n)=>t.map((e,l)=>N(e,n,l)));for(let t=0;t<9;t++)for(let n=0;n<9;n++)r[t][n].value&&p(r,t,n,r[t][n].value);return r}function u(o,r){const t=o.candidates.indexOf(r);return t!==-1?(o.candidates.splice(t,1),!0):!1}function p(o,r,t,n){for(let i=0;i<9;i++)i!==t&&u(o[r][i],n),i!==r&&u(o[i][t],n);const e=Math.floor(r/3)*3,l=Math.floor(t/3)*3;for(let i=e;i<e+3;i++)for(let c=l;c<l+3;c++)(i!==r||c!==t)&&u(o[i][c],n)}function C(o){let r=!1;for(let t=0;t<9;t++)for(let n=0;n<9;n++){const e=o[t][n];!e.value&&e.candidates.length===1&&(e.value=e.candidates[0],e.candidates=[],p(o,t,n,e.value),r=!0)}return r}function P(o){let r=!1;const t=n=>{for(let e=1;e<=9;e++){const l=n.filter(i=>!i.value&&i.candidates.includes(e));l.length===1&&(l[0].value=e,l[0].candidates=[],p(o,l[0].r,l[0].c,e),r=!0)}};for(let n=0;n<9;n++)t(o[n]),t(o.map(e=>e[n]));for(let n=0;n<9;n+=3)for(let e=0;e<9;e+=3){const l=[];for(let i=n;i<n+3;i++)for(let c=e;c<e+3;c++)l.push(o[i][c]);t(l)}return r}function B(o){let r=!1;const t=n=>{const e={};n.forEach(l=>{if(!l.value&&l.candidates.length===2){const i=l.candidates.join(",");e[i]=(e[i]||0)+1}});for(const l in e)if(e[l]===2){const i=l.split(",").map(Number);n.forEach(c=>{!c.value&&c.candidates.join(",")!==l&&i.forEach(f=>{c.candidates.includes(f)&&u(c,f)&&(r=!0)})})}};for(let n=0;n<9;n++)t(o[n]),t(o.map(e=>e[n]));for(let n=0;n<9;n+=3)for(let e=0;e<9;e+=3){const l=[];for(let i=n;i<n+3;i++)for(let c=e;c<e+3;c++)l.push(o[i][c]);t(l)}return r}function E(o){let r=!1;const t=n=>{const e=[];n.forEach(l=>{!l.value&&l.candidates.length>=2&&l.candidates.length<=3&&e.push(l)});for(let l=0;l<e.length;l++)for(let i=l+1;i<e.length;i++)for(let c=i+1;c<e.length;c++){const f=new Set([...e[l].candidates,...e[i].candidates,...e[c].candidates]);if(f.size===3){const s=[...f];n.forEach(a=>{a!==e[l]&&a!==e[i]&&a!==e[c]&&!a.value&&s.forEach(d=>{u(a,d)&&(r=!0)})})}}};for(let n=0;n<9;n++)t(o[n]),t(o.map(e=>e[n]));for(let n=0;n<9;n+=3)for(let e=0;e<9;e+=3){const l=[];for(let i=n;i<n+3;i++)for(let c=e;c<e+3;c++)l.push(o[i][c]);t(l)}return r}function x(o){let r=!1;for(let t=0;t<9;t+=3)for(let n=0;n<9;n+=3)for(let e=1;e<=9;e++){const l=[];for(let i=t;i<t+3;i++)for(let c=n;c<n+3;c++)!o[i][c].value&&o[i][c].candidates.includes(e)&&l.push({r:i,c});if(l.length>1){const i=l.every(f=>f.r===l[0].r),c=l.every(f=>f.c===l[0].c);if(i){const f=l[0].r;for(let s=0;s<9;s++)(s<n||s>=n+3)&&u(o[f][s],e)&&(r=!0)}if(c){const f=l[0].c;for(let s=0;s<9;s++)(s<t||s>=t+3)&&u(o[s][f],e)&&(r=!0)}}}return r}function j(o){let r=!1;for(let t=0;t<9;t++)for(let n=1;n<=9;n++){const e=[];for(let s=0;s<9;s++){const a=o[t][s];!a.value&&a.candidates.includes(n)&&e.push(a)}if(e.length<2)continue;const l=new Set(e.map(s=>Math.floor(s.c/3)));if(l.size!==1)continue;const i=[...l][0],c=Math.floor(t/3)*3,f=i*3;for(let s=c;s<c+3;s++)if(s!==t)for(let a=f;a<f+3;a++)u(o[s][a],n)&&(r=!0)}for(let t=0;t<9;t++)for(let n=1;n<=9;n++){const e=[];for(let s=0;s<9;s++){const a=o[s][t];!a.value&&a.candidates.includes(n)&&e.push(a)}if(e.length<2)continue;const l=new Set(e.map(s=>Math.floor(s.r/3)));if(l.size!==1)continue;const c=[...l][0]*3,f=Math.floor(t/3)*3;for(let s=c;s<c+3;s++)for(let a=f;a<f+3;a++)a!==t&&u(o[s][a],n)&&(r=!0)}return r}function z(o){let r=!1;for(let t=1;t<=9;t++){const n=[];for(let e=0;e<9;e++){const l=[];for(let i=0;i<9;i++)!o[e][i].value&&o[e][i].candidates.includes(t)&&l.push(i);l.length===2&&n.push({r:e,cols:l})}for(let e=0;e<n.length;e++)for(let l=e+1;l<n.length;l++)if(n[e].cols[0]===n[l].cols[0]&&n[e].cols[1]===n[l].cols[1]){const[i,c]=n[e].cols;for(let f=0;f<9;f++)f!==n[e].r&&f!==n[l].r&&(u(o[f][i],t)&&(r=!0),u(o[f][c],t)&&(r=!0))}}return r}function H(o){let r=!1;for(let t=1;t<=9;t++){const n=[];for(let e=0;e<9;e++){const l=[];for(let i=0;i<9;i++)!o[e][i].value&&o[e][i].candidates.includes(t)&&l.push(o[e][i]);l.length===2&&n.push(l)}n.forEach(([e,l])=>{for(let i=0;i<9;i++)for(let c=0;c<9;c++){const f=o[i][c];f!==e&&f!==l&&f.candidates.includes(t)&&(f.r===e.r||f.c===e.c)&&u(f,t)&&(r=!0)}})}return r}function T(o){return o.map(r=>r.map(t=>t.value?t.value:`(${t.candidates.join("")})`).join(",")).join("|")}function A(o){const r=M(o),t={NakedSingle:0,HiddenSingle:0,NakedPair:0,NakedTriple:0,Pointing:0,Claiming:0,XWing:0,SimpleColoring:0};let n="";for(;;){const a=T(r);if(a===n)break;if(n=a,C(r)){t.NakedSingle++;continue}if(P(r)){t.HiddenSingle++;continue}if(B(r)){t.NakedPair++;continue}if(E(r)){t.NakedTriple++;continue}if(x(r)){t.Pointing++;continue}if(j(r)){t.Claiming++;continue}if(z(r)){t.XWing++;continue}if(H(r)){t.SimpleColoring++;continue}break}const e=["NakedSingle","HiddenSingle","NakedPair","NakedTriple","Pointing","Claiming","XWing","SimpleColoring"];let l=null;for(let a=e.length-1;a>=0;a--)if(t[e[a]]){l=e[a];break}function i(a){let d=0;for(const g in a)d+=a[g]*(y[g]||0);return Number(d.toFixed(2))}const c=r.every(a=>a.every(d=>d.value));let f=!1,s=null;if(!c){const a=r.some(g=>g.some(h=>!h.value));r.some(g=>g.some(h=>!h.value&&h.candidates.length===0))?(f=!0,s="contradiction"):a&&(f=!0,s="noMoreLogicalMoves")}return{solved:c,stalled:f,stallReason:s,techniquesUsed:t,maxTechnique:l,score:i(t)}}function k(o){for(let r=0;r<9;r++)for(let t=0;t<9;t++)if(o[r][t]===null){const n=m([1,2,3,4,5,6,7,8,9]);for(let e of n)if(S(o,r,t,e)){if(o[r][t]=e,k(o))return!0;o[r][t]=null}return!1}return!0}function W(o,r=2){let t=0,n=0;const e=2e4;function l(i){if(++n>e){t=r;return}if(!(t>=r)){for(let c=0;c<9;c++)for(let f=0;f<9;f++)if(i[c][f]===null){for(let s=1;s<=9;s++)S(i,c,f,s)&&(i[c][f]=s,l(i),i[c][f]=null);return}t++}}return l(v(o)),t}function X({board:o,solution:r}){k(o);for(let n=0;n<9;n++)for(let e=0;e<9;e++)r[n][e]=o[n][e];const t=m([...Array(81).keys()]);for(let n of t){const e=Math.floor(n/9),l=n%9,i=o[e][l];if(o[e][l]=null,W(o)!==1){o[e][l]=i;continue}}}function w(o){const r=v(o);return A(r)}function D(o,r){if(!o.solved)return!1;const t=o.score;switch(r){case"easy":return t<1.5;case"medium":return t>=1.5&&t<3.5;case"hard":return t>=3.5&&t<6;case"veryHard":return t>=6;default:return!1}}function U(o){let r=0;for(;r<200;){r++;const t=Array.from({length:9},()=>Array(9).fill(null)),n=Array.from({length:9},()=>Array(9).fill(null));X({board:t,solution:n});const e=w(t);if(D(e,o))return console.log("퍼즐 생성 성공",e),{puzzle:t,solution:n};console.log("퍼즐 생성 실패 난이도 조건 미달",e)}if(r>=200)return console.log("퍼즐 생성 실패 → fallback"),null}self.onmessage=o=>{const{difficulty:r}=o.data;try{const t=U(r);self.postMessage({ok:!0,result:t})}catch(t){self.postMessage({ok:!1,error:t?.message??"generator error"})}}})();
