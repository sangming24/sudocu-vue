(function(){"use strict";function y(t){for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return t}function g(t){return t.map(n=>n.slice())}function p(t,n,e,r){for(let l=0;l<9;l++)if(t[n][l]===r||t[l][e]===r)return!1;const o=Math.floor(n/3)*3,i=Math.floor(e/3)*3;for(let l=o;l<o+3;l++)for(let a=i;a<i+3;a++)if(t[l][a]===r)return!1;return!0}function S(t,n,e){return{value:t,candidates:t?[]:[1,2,3,4,5,6,7,8,9],r:n,c:e}}function P(t){const n=t.map((e,r)=>e.map((o,i)=>S(o,r,i)));for(let e=0;e<9;e++)for(let r=0;r<9;r++)n[e][r].value&&m(n,e,r,n[e][r].value);return n}function c(t,n){const e=t.candidates.indexOf(n);return e!==-1?(t.candidates.splice(e,1),!0):!1}function m(t,n,e,r){for(let l=0;l<9;l++)l!==e&&c(t[n][l],r),l!==n&&c(t[l][e],r);const o=Math.floor(n/3)*3,i=Math.floor(e/3)*3;for(let l=o;l<o+3;l++)for(let a=i;a<i+3;a++)(l!==n||a!==e)&&c(t[l][a],r)}function M(t){let n=!1;for(let e=0;e<9;e++)for(let r=0;r<9;r++){const o=t[e][r];!o.value&&o.candidates.length===1&&(o.value=o.candidates[0],o.candidates=[],m(t,e,r,o.value),n=!0)}return n}function C(t){let n=!1;const e=r=>{for(let o=1;o<=9;o++){const i=r.filter(l=>!l.value&&l.candidates.includes(o));i.length===1&&(i[0].value=o,i[0].candidates=[],m(t,i[0].r,i[0].c,o),n=!0)}};for(let r=0;r<9;r++)e(t[r]),e(t.map(o=>o[r]));for(let r=0;r<9;r+=3)for(let o=0;o<9;o+=3){const i=[];for(let l=r;l<r+3;l++)for(let a=o;a<o+3;a++)i.push(t[l][a]);e(i)}return n}function N(t){let n=!1;const e=r=>{const o={};r.forEach(i=>{if(!i.value&&i.candidates.length===2){const l=i.candidates.join(",");o[l]=(o[l]||0)+1}});for(const i in o)if(o[i]===2){const l=i.split(",").map(Number);r.forEach(a=>{!a.value&&a.candidates.join(",")!==i&&l.forEach(s=>{a.candidates.includes(s)&&c(a,s)&&(n=!0)})})}};for(let r=0;r<9;r++)e(t[r]),e(t.map(o=>o[r]));for(let r=0;r<9;r+=3)for(let o=0;o<9;o+=3){const i=[];for(let l=r;l<r+3;l++)for(let a=o;a<o+3;a++)i.push(t[l][a]);e(i)}return n}function x(t){let n=!1;for(let e=0;e<9;e+=3)for(let r=0;r<9;r+=3)for(let o=1;o<=9;o++){const i=[];for(let l=e;l<e+3;l++)for(let a=r;a<r+3;a++)!t[l][a].value&&t[l][a].candidates.includes(o)&&i.push({r:l,c:a});if(i.length>1){const l=i.every(s=>s.r===i[0].r),a=i.every(s=>s.c===i[0].c);if(l){const s=i[0].r;for(let f=0;f<9;f++)(f<r||f>=r+3)&&(c(t[s][f],o),n=!0)}if(a){const s=i[0].c;for(let f=0;f<9;f++)(f<e||f>=e+3)&&(c(t[f][s],o),n=!0)}}}return n}function B(t){let n=!1;for(let e=0;e<9;e++)for(let r=1;r<=9;r++){const o=t[e].filter(s=>!s.value&&s.candidates.includes(r));if(o.length<2)continue;const i=Math.floor(o[0].c/3);if(!o.every(s=>Math.floor(s.c/3)===i))continue;const l=Math.floor(e/3)*3,a=i*3;for(let s=l;s<l+3;s++)if(s!==e)for(let f=a;f<a+3;f++)c(t[s][f],r)&&(n=!0)}return n}function z(t){return t.map(n=>n.map(e=>`${e.value??0}:${e.candidates.join("")}`).join("|")).join(`
`)}function v(t){const n=P(t),e={NakedSingle:!1,HiddenSingle:!1,NakedPair:!1,Pointing:!1,Claiming:!1};let r="";for(;;){const f=z(n);if(f===r)break;if(r=f,M(n)){e.NakedSingle=!0;continue}if(C(n)){e.HiddenSingle=!0;continue}if(N(n)){e.NakedPair=!0;continue}if(x(n)){e.Pointing=!0;continue}if(B(n)){e.Claiming=!0;continue}break}const o=["NakedSingle","HiddenSingle","NakedPair","Pointing","Claiming"];let i=null;for(let f=o.length-1;f>=0;f--)if(e[o[f]]){i=o[f];break}const l=n.every(f=>f.every(u=>u.value));let a=!1,s=null;if(!l){const f=n.some(d=>d.some(h=>!h.value));n.some(d=>d.some(h=>!h.value&&h.candidates.length===0))?(a=!0,s="contradiction"):f&&(a=!0,s="noMoreLogicalMoves")}return{solved:l,stalled:a,stallReason:s,techniquesUsed:e,maxTechnique:i}}function j(t){switch(t){case"easy":return 30;case"medium":return 40;case"hard":return 50;case"expert":return 60;default:return 40}}function k(t){for(let n=0;n<9;n++)for(let e=0;e<9;e++)if(t[n][e]===null){const r=y([1,2,3,4,5,6,7,8,9]);for(let o of r)if(p(t,n,e,o)){if(t[n][e]=o,k(t))return!0;t[n][e]=null}return!1}return!0}function A(t,n=2){let e=0,r=0;const o=2e4;function i(l){if(++r>o){e=n;return}if(!(e>=n)){for(let a=0;a<9;a++)for(let s=0;s<9;s++)if(l[a][s]===null){for(let f=1;f<=9;f++)p(l,a,s,f)&&(l[a][s]=f,i(l),l[a][s]=null);return}e++}}return i(g(t)),e}function E({board:t,solution:n,empty:e}){k(t);for(let i=0;i<9;i++)for(let l=0;l<9;l++)n[i][l]=t[i][l];const r=y([...Array(81).keys()]);let o=0;for(let i of r){if(e<=0||o>100)break;o++;const l=Math.floor(i/9),a=i%9,s=t[l][a];t[l][a]=null,A(t)!==1?t[l][a]=s:e--}}function H(t){const n=g(t);return v(n)}function D(t,n){const e=t.techniquesUsed;if(n==="expert")return t.stalled&&t.stallReason==="noMoreLogicalMoves";if(!t.solved||t.stalled)return!1;switch(n){case"easy":return e.NakedSingle&&!e.HiddenSingle&&!e.NakedPair&&!e.Pointing&&!e.Claiming;case"medium":return e.HiddenSingle&&!e.NakedPair&&!e.Pointing&&!e.Claiming;case"hard":return e.NakedPair||e.Pointing;case"expert":return e.Claiming||t.stalled&&!t.solved;default:return!1}}function R(t){let n=0;for(;n<200;){n++;const e=Array.from({length:9},()=>Array(9).fill(null)),r=Array.from({length:9},()=>Array(9).fill(null)),o=j(t);E({board:e,solution:r,empty:o});const i=H(e);if(t==="expert"){if(i.stalled&&!i.solved){const l=U(e);if(l.solved)return console.log("C단계 퍼즐 확정",l),{puzzle:e,solution:r}}}else if(D(i,t))return console.log("퍼즐 생성 성공",i),{puzzle:e,solution:r};console.log("퍼즐 생성 실패",i)}if(n>=200)return console.warn("퍼즐 생성 실패 → fallback"),null}function U(t){let n=0,e=0;function r(i){const l=v(i);if(l.solved)return!0;if(!l.stalled)return!1;let a=null;for(let s=0;s<9;s++)for(let f=0;f<9;f++)if(i[s][f]===null){const u=[1,2,3,4,5,6,7,8,9].filter(d=>p(i,s,f,d));(!a||u.length<a.candidates.length)&&(a={r:s,c:f,candidates:u})}if(!a)return!1;e=Math.max(e,a.candidates.length);for(let s of a.candidates){n++;const f=g(i);if(f[a.r][a.c]=s,v(f).solved)return!0}return!1}return{solved:r(g(t)),guessCount:n,maxCandidates:e}}self.onmessage=t=>{const{difficulty:n}=t.data;try{const e=R(n);self.postMessage({ok:!0,result:e})}catch(e){self.postMessage({ok:!1,error:e?.message??"generator error"})}}})();
