(function(){"use strict";function y(t){for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return t}function g(t){return t.map(n=>n.slice())}function p(t,n,e,l){for(let r=0;r<9;r++)if(t[n][r]===l||t[r][e]===l)return!1;const o=Math.floor(n/3)*3,i=Math.floor(e/3)*3;for(let r=o;r<o+3;r++)for(let a=i;a<i+3;a++)if(t[r][a]===l)return!1;return!0}function S(t,n,e){return{value:t,candidates:t?[]:[1,2,3,4,5,6,7,8,9],r:n,c:e}}function P(t){const n=t.map((e,l)=>e.map((o,i)=>S(o,l,i)));for(let e=0;e<9;e++)for(let l=0;l<9;l++)n[e][l].value&&m(n,e,l,n[e][l].value);return n}function c(t,n){const e=t.candidates.indexOf(n);return e!==-1?(t.candidates.splice(e,1),!0):!1}function m(t,n,e,l){for(let r=0;r<9;r++)r!==e&&c(t[n][r],l),r!==n&&c(t[r][e],l);const o=Math.floor(n/3)*3,i=Math.floor(e/3)*3;for(let r=o;r<o+3;r++)for(let a=i;a<i+3;a++)(r!==n||a!==e)&&c(t[r][a],l)}function C(t){let n=!1;for(let e=0;e<9;e++)for(let l=0;l<9;l++){const o=t[e][l];!o.value&&o.candidates.length===1&&(o.value=o.candidates[0],o.candidates=[],m(t,e,l,o.value),n=!0)}return n}function M(t){let n=!1;const e=l=>{for(let o=1;o<=9;o++){const i=l.filter(r=>!r.value&&r.candidates.includes(o));i.length===1&&(i[0].value=o,i[0].candidates=[],m(t,i[0].r,i[0].c,o),n=!0)}};for(let l=0;l<9;l++)e(t[l]),e(t.map(o=>o[l]));for(let l=0;l<9;l+=3)for(let o=0;o<9;o+=3){const i=[];for(let r=l;r<l+3;r++)for(let a=o;a<o+3;a++)i.push(t[r][a]);e(i)}return n}function N(t){let n=!1;const e=l=>{const o={};l.forEach(i=>{if(!i.value&&i.candidates.length===2){const r=i.candidates.join(",");o[r]=(o[r]||0)+1}});for(const i in o)if(o[i]===2){const r=i.split(",").map(Number);l.forEach(a=>{!a.value&&a.candidates.join(",")!==i&&r.forEach(s=>{a.candidates.includes(s)&&c(a,s)&&(n=!0)})})}};for(let l=0;l<9;l++)e(t[l]),e(t.map(o=>o[l]));for(let l=0;l<9;l+=3)for(let o=0;o<9;o+=3){const i=[];for(let r=l;r<l+3;r++)for(let a=o;a<o+3;a++)i.push(t[r][a]);e(i)}return n}function x(t){let n=!1;for(let e=0;e<9;e+=3)for(let l=0;l<9;l+=3)for(let o=1;o<=9;o++){const i=[];for(let r=e;r<e+3;r++)for(let a=l;a<l+3;a++)!t[r][a].value&&t[r][a].candidates.includes(o)&&i.push({r,c:a});if(i.length>1){const r=i.every(s=>s.r===i[0].r),a=i.every(s=>s.c===i[0].c);if(r){const s=i[0].r;for(let f=0;f<9;f++)(f<l||f>=l+3)&&(c(t[s][f],o),n=!0)}if(a){const s=i[0].c;for(let f=0;f<9;f++)(f<e||f>=e+3)&&(c(t[f][s],o),n=!0)}}}return n}function B(t){let n=!1;for(let e=0;e<9;e++)for(let l=1;l<=9;l++){const o=t[e].filter(s=>!s.value&&s.candidates.includes(l));if(o.length<2)continue;const i=Math.floor(o[0].c/3);if(!o.every(s=>Math.floor(s.c/3)===i))continue;const r=Math.floor(e/3)*3,a=i*3;for(let s=r;s<r+3;s++)if(s!==e)for(let f=a;f<a+3;f++)c(t[s][f],l)&&(n=!0)}return n}function E(t){return t.map(n=>n.map(e=>`${e.value??0}:${e.candidates.join("")}`).join("|")).join(`
`)}function v(t){const n=P(t),e={NakedSingle:!1,HiddenSingle:!1,NakedPair:!1,Pointing:!1,Claiming:!1};let l="";for(;;){const f=E(n);if(f===l)break;if(l=f,C(n)){e.NakedSingle=!0;continue}if(M(n)){e.HiddenSingle=!0;continue}if(N(n)){e.NakedPair=!0;continue}if(x(n)){e.Pointing=!0;continue}if(B(n)){e.Claiming=!0;continue}break}const o=["NakedSingle","HiddenSingle","NakedPair","Pointing","Claiming"];let i=null;for(let f=o.length-1;f>=0;f--)if(e[o[f]]){i=o[f];break}const r=n.every(f=>f.every(u=>u.value));let a=!1,s=null;if(!r){const f=n.some(d=>d.some(h=>!h.value));n.some(d=>d.some(h=>!h.value&&h.candidates.length===0))?(a=!0,s="contradiction"):f&&(a=!0,s="noMoreLogicalMoves")}return{solved:r,stalled:a,stallReason:s,techniquesUsed:e,maxTechnique:i}}function z(t){switch(t){case"easy":return 30;case"medium":return 40;case"hard":return 50;case"expert":return 60;default:return 40}}function k(t){for(let n=0;n<9;n++)for(let e=0;e<9;e++)if(t[n][e]===null){const l=y([1,2,3,4,5,6,7,8,9]);for(let o of l)if(p(t,n,e,o)){if(t[n][e]=o,k(t))return!0;t[n][e]=null}return!1}return!0}function j(t,n=2){let e=0,l=0;const o=2e4;function i(r){if(++l>o){e=n;return}if(!(e>=n)){for(let a=0;a<9;a++)for(let s=0;s<9;s++)if(r[a][s]===null){for(let f=1;f<=9;f++)p(r,a,s,f)&&(r[a][s]=f,i(r),r[a][s]=null);return}e++}}return i(g(t)),e}function A({board:t,solution:n,empty:e}){k(t);for(let i=0;i<9;i++)for(let r=0;r<9;r++)n[i][r]=t[i][r];const l=y([...Array(81).keys()]);let o=0;for(let i of l){if(e<=0||o>100)break;o++;const r=Math.floor(i/9),a=i%9,s=t[r][a];t[r][a]=null,j(t)!==1?t[r][a]=s:e--}}function H(t){const n=g(t);return v(n)}function R(t,n){const e=t.techniquesUsed;if(n==="expert")return t.stalled&&t.stallReason==="noMoreLogicalMoves";if(!t.solved||t.stalled)return!1;switch(n){case"easy":return e.NakedSingle&&!e.HiddenSingle&&!e.NakedPair&&!e.Pointing&&!e.Claiming;case"medium":return e.HiddenSingle&&!e.NakedPair&&!e.Pointing&&!e.Claiming;case"hard":return e.NakedPair||e.Pointing;case"expert":return e.Claiming||t.stalled&&!t.solved;default:return!1}}function U(t){let n=0;for(;n<200;){n++;const e=Array.from({length:9},()=>Array(9).fill(null)),l=Array.from({length:9},()=>Array(9).fill(null)),o=z(t);A({board:e,solution:l,empty:o});const i=H(e);if(t==="expert"){if(i.stalled&&!i.solved){const r=D(e);if(r.solved)return console.log("C단계 퍼즐 확정",r),{puzzle:e,solution:l}}}else if(R(i,t))return console.log("퍼즐 생성 성공",i),{puzzle:e,solution:l};console.log("퍼즐 생성 실패",i)}if(n>=200)return console.warn("퍼즐 생성 실패 → fallback"),null}function D(t){let n=0,e=0;function l(i){const r=v(i);if(r.solved)return!0;if(!r.stalled)return!1;let a=null;for(let s=0;s<9;s++)for(let f=0;f<9;f++)if(i[s][f]===null){const u=[1,2,3,4,5,6,7,8,9].filter(d=>p(i,s,f,d));(!a||u.length<a.candidates.length)&&(a={r:s,c:f,candidates:u})}if(!a)return!1;e=Math.max(e,a.candidates.length);for(let s of a.candidates){n++;const f=g(i);if(f[a.r][a.c]=s,v(f).solved)return!0}return!1}return{solved:l(g(t)),guessCount:n,maxCandidates:e}}self.onmessage=t=>{const{type:n,difficulty:e}=t.data;if(console.log("type",n),console.log("difficulty",e),n==="GENERATE"){const l=U(e);self.postMessage({type:"RESULT",result:l})}}})();
