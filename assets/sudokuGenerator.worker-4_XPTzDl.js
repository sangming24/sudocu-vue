(function(){"use strict";function W(c){for(let l=c.length-1;l>0;l--){const n=Math.floor(Math.random()*(l+1));[c[l],c[n]]=[c[n],c[l]]}return c}function M(c){return c.map(l=>l.slice())}function U(c,l,n,r){for(let e=0;e<9;e++)if(c[l][e]===r||c[e][n]===r)return!1;const s=Math.floor(l/3)*3,o=Math.floor(n/3)*3;for(let e=s;e<s+3;e++)for(let t=o;t<o+3;t++)if(c[e][t]===r)return!1;return!0}const T={NakedSingle:.1,HiddenSingle:.2,NakedPair:1,NakedTriple:1.4,Pointing:1.2,Claiming:1.3,XWing:2.5,TwoStringKite:2.8,Skyscraper:3,WWing:3.2};function B(c,l,n){return{value:c,candidates:c?[]:[1,2,3,4,5,6,7,8,9],r:l,c:n}}function C(c){const l=c.map((n,r)=>n.map((s,o)=>B(s,r,o)));for(let n=0;n<9;n++)for(let r=0;r<9;r++)l[n][r].value&&w(l,n,r,l[n][r].value);return l}function v(c,l){const n=c.candidates.indexOf(l);return n!==-1?(c.candidates.splice(n,1),!0):!1}function w(c,l,n,r){for(let e=0;e<9;e++)e!==n&&v(c[l][e],r),e!==l&&v(c[e][n],r);const s=Math.floor(l/3)*3,o=Math.floor(n/3)*3;for(let e=s;e<s+3;e++)for(let t=o;t<o+3;t++)(e!==l||t!==n)&&v(c[e][t],r)}function N(c){let l=!1;for(let n=0;n<9;n++)for(let r=0;r<9;r++){const s=c[n][r];!s.value&&s.candidates.length===1&&(s.value=s.candidates[0],s.candidates=[],w(c,n,r,s.value),l=!0)}return l}function P(c){let l=!1;const n=r=>{for(let s=1;s<=9;s++){const o=r.filter(e=>!e.value&&e.candidates.includes(s));o.length===1&&(o[0].value=s,o[0].candidates=[],w(c,o[0].r,o[0].c,s),l=!0)}};for(let r=0;r<9;r++)n(c[r]),n(c.map(s=>s[r]));for(let r=0;r<9;r+=3)for(let s=0;s<9;s+=3){const o=[];for(let e=r;e<r+3;e++)for(let t=s;t<s+3;t++)o.push(c[e][t]);n(o)}return l}function A(c){let l=!1;const n=r=>{const s={};r.forEach(o=>{if(!o.value&&o.candidates.length===2){const e=o.candidates.join(",");s[e]=(s[e]||0)+1}});for(const o in s)if(s[o]===2){const e=o.split(",").map(Number);r.forEach(t=>{!t.value&&t.candidates.join(",")!==o&&e.forEach(i=>{t.candidates.includes(i)&&v(t,i)&&(l=!0)})})}};for(let r=0;r<9;r++)n(c[r]),n(c.map(s=>s[r]));for(let r=0;r<9;r+=3)for(let s=0;s<9;s+=3){const o=[];for(let e=r;e<r+3;e++)for(let t=s;t<s+3;t++)o.push(c[e][t]);n(o)}return l}function R(c){let l=!1;const n=r=>{const s=[];r.forEach(o=>{!o.value&&o.candidates.length>=2&&o.candidates.length<=3&&s.push(o)});for(let o=0;o<s.length;o++)for(let e=o+1;e<s.length;e++)for(let t=e+1;t<s.length;t++){const i=new Set([...s[o].candidates,...s[e].candidates,...s[t].candidates]);if(i.size===3){const f=[...i];r.forEach(d=>{d!==s[o]&&d!==s[e]&&d!==s[t]&&!d.value&&f.forEach(a=>{v(d,a)&&(l=!0)})})}}};for(let r=0;r<9;r++)n(c[r]),n(c.map(s=>s[r]));for(let r=0;r<9;r+=3)for(let s=0;s<9;s+=3){const o=[];for(let e=r;e<r+3;e++)for(let t=s;t<s+3;t++)o.push(c[e][t]);n(o)}return l}function x(c){let l=!1;for(let n=0;n<9;n+=3)for(let r=0;r<9;r+=3)for(let s=1;s<=9;s++){const o=[];for(let e=n;e<n+3;e++)for(let t=r;t<r+3;t++)!c[e][t].value&&c[e][t].candidates.includes(s)&&o.push({r:e,c:t});if(o.length===2||o.length===3){const e=o.every(i=>i.r===o[0].r),t=o.every(i=>i.c===o[0].c);if(e){const i=o[0].r;for(let f=0;f<9;f++)(f<r||f>=r+3)&&v(c[i][f],s)&&(l=!0)}if(t){const i=o[0].c;for(let f=0;f<9;f++)(f<n||f>=n+3)&&v(c[f][i],s)&&(l=!0)}}}return l}function H(c){let l=!1;for(let n=0;n<9;n++)for(let r=1;r<=9;r++){const s=[];for(let f=0;f<9;f++){const d=c[n][f];!d.value&&d.candidates.includes(r)&&s.push(d)}if(s.length<2)continue;const o=new Set(s.map(f=>Math.floor(f.c/3)));if(o.size!==1)continue;const e=[...o][0],t=Math.floor(n/3)*3,i=e*3;for(let f=t;f<t+3;f++)if(f!==n)for(let d=i;d<i+3;d++)v(c[f][d],r)&&(l=!0)}for(let n=0;n<9;n++)for(let r=1;r<=9;r++){const s=[];for(let f=0;f<9;f++){const d=c[f][n];!d.value&&d.candidates.includes(r)&&s.push(d)}if(s.length<2)continue;const o=new Set(s.map(f=>Math.floor(f.r/3)));if(o.size!==1)continue;const t=[...o][0]*3,i=Math.floor(n/3)*3;for(let f=t;f<t+3;f++)for(let d=i;d<i+3;d++)d!==n&&v(c[f][d],r)&&(l=!0)}return l}function j(c){let l=!1;for(let n=1;n<=9;n++){const r=[];for(let o=0;o<9;o++){const e=[];for(let t=0;t<9;t++){const i=c[o][t];!i.value&&i.candidates.includes(n)&&e.push(t)}e.length===2&&r.push({r:o,cols:e})}for(let o=0;o<r.length;o++)for(let e=o+1;e<r.length;e++){const t=r[o],i=r[e];if(t.cols[0]===i.cols[0]&&t.cols[1]===i.cols[1]){const f=t.cols[0],d=t.cols[1];for(let a=0;a<9;a++)a!==t.r&&a!==i.r&&(v(c[a][f],n)&&(l=!0),v(c[a][d],n)&&(l=!0))}}const s=[];for(let o=0;o<9;o++){const e=[];for(let t=0;t<9;t++){const i=c[t][o];!i.value&&i.candidates.includes(n)&&e.push(t)}e.length===2&&s.push({c:o,rows:e})}for(let o=0;o<s.length;o++)for(let e=o+1;e<s.length;e++){const t=s[o],i=s[e];if(t.rows[0]===i.rows[0]&&t.rows[1]===i.rows[1]){const f=t.rows[0],d=t.rows[1];for(let a=0;a<9;a++)a!==t.c&&a!==i.c&&(v(c[f][a],n)&&(l=!0),v(c[d][a],n)&&(l=!0))}}}return l}function X(c){let l=!1;for(let n=1;n<=9;n++){const r=[];for(let o=0;o<9;o++){const e=[];for(let t=0;t<9;t++){const i=c[o][t];!i.value&&i.candidates.includes(n)&&e.push({r:o,c:t})}e.length===2&&r.push(e)}const s=[];for(let o=0;o<9;o++){const e=[];for(let t=0;t<9;t++){const i=c[t][o];!i.value&&i.candidates.includes(n)&&e.push({r:t,c:o})}e.length===2&&s.push(e)}r.forEach(([o,e])=>{s.forEach(([t,i])=>{if(!(o.r===t.r&&o.c===t.c&&e.c!==i.c||o.r===i.r&&o.c===i.c&&e.c!==t.c||e.r===t.r&&e.c===t.c&&o.c!==i.c||e.r===i.r&&e.c===i.c&&o.c!==t.c))return;const d=o.r===t.r&&o.c===t.c?e:o,a=t.r===o.r&&t.c===o.c?i:t;for(let h=0;h<9;h++)for(let u=0;u<9;u++){const g=c[h][u];if(g.value||!g.candidates.includes(n))continue;const y=h===d.r||u===d.c||Math.floor(h/3)===Math.floor(d.r/3),S=h===a.r||u===a.c||Math.floor(u/3)===Math.floor(a.c/3);y&&S&&v(g,n)&&(l=!0)}})})}return l}function z(c){let l=!1;for(let n=1;n<=9;n++){const r=[];for(let o=0;o<9;o++){const e=[];for(let t=0;t<9;t++){const i=c[o][t];!i.value&&i.candidates.includes(n)&&e.push(t)}e.length===2&&r.push({r:o,cols:e})}for(let o=0;o<r.length;o++)for(let e=o+1;e<r.length;e++){const t=r[o],i=r[e],f=t.cols.filter(u=>i.cols.includes(u));if(f.length!==1)continue;const d=f[0],a=t.cols.find(u=>u!==d),h=i.cols.find(u=>u!==d);for(let u=0;u<9;u++)for(let g=0;g<9;g++){const y=c[u][g];if(y.value||!y.candidates.includes(n))continue;const S=u===t.r||g===a||Math.floor(u/3)===Math.floor(t.r/3),m=u===i.r||g===h||Math.floor(u/3)===Math.floor(i.r/3);S&&m&&v(y,n)&&(l=!0)}}const s=[];for(let o=0;o<9;o++){const e=[];for(let t=0;t<9;t++){const i=c[t][o];!i.value&&i.candidates.includes(n)&&e.push(t)}e.length===2&&s.push({c:o,rows:e})}for(let o=0;o<s.length;o++)for(let e=o+1;e<s.length;e++){const t=s[o],i=s[e],f=t.rows.filter(u=>i.rows.includes(u));if(f.length!==1)continue;const d=f[0],a=t.rows.find(u=>u!==d),h=i.rows.find(u=>u!==d);for(let u=0;u<9;u++)for(let g=0;g<9;g++){const y=c[u][g];if(y.value||!y.candidates.includes(n))continue;const S=u===a||g===t.c||Math.floor(g/3)===Math.floor(t.c/3),m=u===h||g===i.c||Math.floor(g/3)===Math.floor(i.c/3);S&&m&&v(y,n)&&(l=!0)}}}return l}function K(c){let l=!1;const n=[];for(let s=0;s<9;s++)for(let o=0;o<9;o++){const e=c[s][o];!e.value&&e.candidates.length===2&&n.push({r:s,c:o,nums:[...e.candidates]})}for(let s=0;s<n.length;s++)for(let o=s+1;o<n.length;o++){const e=n[s],t=n[o];if(e.nums[0]!==t.nums[0]||e.nums[1]!==t.nums[1])continue;const i=e.r===t.r,f=e.c===t.c,d=Math.floor(e.r/3)===Math.floor(t.r/3)&&Math.floor(e.c/3)===Math.floor(t.c/3);if(i||f||d)continue;const[a,h]=e.nums;[a,h].forEach(u=>{for(let m=0;m<9;m++){const p=[];for(let k=0;k<9;k++)!c[m][k].value&&c[m][k].candidates.includes(u)&&p.push({r:m,c:k});p.length===2&&(p[0].r===e.r&&p[0].c===e.c&&p[1].r===t.r&&p[1].c===t.c||p[1].r===e.r&&p[1].c===e.c&&p[0].r===t.r&&p[0].c===t.c)&&r(c,e,t,a,h,u)}for(let m=0;m<9;m++){const p=[];for(let k=0;k<9;k++)!c[k][m].value&&c[k][m].candidates.includes(u)&&p.push({r:k,c:m});p.length===2&&(p[0].r===e.r&&p[0].c===e.c&&p[1].r===t.r&&p[1].c===t.c||p[1].r===e.r&&p[1].c===e.c&&p[0].r===t.r&&p[0].c===t.c)&&r(c,e,t,a,h,u)}const g=Math.floor(e.r/3)*3,y=Math.floor(e.c/3)*3,S=[];for(let m=g;m<g+3;m++)for(let p=y;p<y+3;p++)!c[m][p].value&&c[m][p].candidates.includes(u)&&S.push({r:m,c:p});S.length===2&&(S[0].r===e.r&&S[0].c===e.c&&S[1].r===t.r&&S[1].c===t.c||S[1].r===e.r&&S[1].c===e.c&&S[0].r===t.r&&S[0].c===t.c)&&r(c,e,t,a,h,u)})}function r(s,o,e,t,i,f){const d=f===t?i:t;for(let a=0;a<9;a++)for(let h=0;h<9;h++){const u=s[a][h];if(u.value||!u.candidates.includes(d))continue;const g=a===o.r||h===o.c||Math.floor(a/3)===Math.floor(o.r/3),y=a===e.r||h===e.c||Math.floor(a/3)===Math.floor(e.r/3);g&&y&&v(u,d)&&(l=!0)}}return l}function E(c){const l=C(c),n={NakedSingle:0,HiddenSingle:0,NakedPair:0,NakedTriple:0,Pointing:0,Claiming:0,XWing:0,TwoStringKite:0,Skyscraper:0,WWing:0};let r=0;const s=500;for(;r++<s;){let a=!1;if(N(l)?(n.NakedSingle++,a=!0):P(l)?(n.HiddenSingle++,a=!0):A(l)?(n.NakedPair++,a=!0):R(l)?(n.NakedTriple++,a=!0):x(l)?(n.Pointing++,a=!0):H(l)?(n.Claiming++,a=!0):j(l)?(n.XWing++,a=!0):X(l)?(n.TwoStringKite++,a=!0):z(l)?(n.Skyscraper++,a=!0):K(l)&&(n.WWing++,a=!0),!a)break}const o=["NakedSingle","HiddenSingle","NakedPair","NakedTriple","Pointing","Claiming","XWing","TwoStringKite","Skyscraper","WWing"];let e=null;for(let a=o.length-1;a>=0;a--)if(n[o[a]]){e=o[a];break}function t(a){let h=0;for(const u in a)h+=a[u]*(T[u]||0);return Number(h.toFixed(2))}const i=l.every(a=>a.every(h=>h.value));let f=!1,d=null;if(!i){const a=l.some(u=>u.some(g=>!g.value));l.some(u=>u.some(g=>!g.value&&g.candidates.length===0))?(f=!0,d="contradiction"):a&&(f=!0,d="noMoreLogicalMoves")}return{solved:i,stalled:f,stallReason:d,techniquesUsed:n,maxTechnique:e,score:t(n)}}function q(c){for(let l=0;l<9;l++)for(let n=0;n<9;n++)if(c[l][n]===null){const r=W([1,2,3,4,5,6,7,8,9]);for(let s of r)if(U(c,l,n,s)){if(c[l][n]=s,q(c))return!0;c[l][n]=null}return!1}return!0}function L(c,l=2){let n=0,r=0;const s=2e4;function o(e){if(++r>s){n=l;return}if(!(n>=l)){for(let t=0;t<9;t++)for(let i=0;i<9;i++)if(e[t][i]===null){for(let f=1;f<=9;f++)U(e,t,i,f)&&(e[t][i]=f,o(e),e[t][i]=null);return}n++}}return o(M(c)),n}function D(c,l){const n=E(M(c));if(!n.solved&&n.stalled)return"fail";const r=n.techniquesUsed.NakedSingle+n.techniquesUsed.HiddenSingle,s=n.techniquesUsed.XWing+n.techniquesUsed.TwoStringKite+n.techniquesUsed.Skyscraper+n.techniquesUsed.WWing>0;return l==="easy"&&n.techniquesUsed.NakedPair+n.techniquesUsed.NakedTriple+n.techniquesUsed.Pointing+n.techniquesUsed.Claiming+n.techniquesUsed.XWing+n.techniquesUsed.TwoStringKite+n.techniquesUsed.Skyscraper+n.techniquesUsed.WWing>0?"tooHard":l==="medium"&&r>30||l==="hard"&&r>20||l==="veryHard"&&(r>15||!s&&r>10)?"tooEasy":"ok"}function F(c){return c.techniquesUsed.XWing+c.techniquesUsed.TwoStringKite+c.techniquesUsed.Skyscraper+c.techniquesUsed.WWing>0}function I(c){const l=M(c);return E(l)}function _(c){let l=0;const n=performance.now();for(;l<200;){l++;const r=Array.from({length:9},()=>Array(9).fill(null)),s=Array.from({length:9},()=>Array(9).fill(null)),o=O({board:r,solution:s,difficulty:c}),e=I(r);if(G(e,c)){const t=performance.now();return console.log("생성 시간 : ",((t-n)/1e3).toFixed(3),"s, 시도 횟수 : ",l," 빈칸 수 : ",o),console.log("퍼즐 생성 성공",e),{puzzle:r,solution:s}}}if(l>=200){const r=performance.now();return console.log("생성 시간 : ",((r-n)/1e3).toFixed(3),"s"),console.log("퍼즐 생성 실패 → fallback"),null}}function O({board:c,solution:l,difficulty:n}){q(c);for(let e=0;e<9;e++)for(let t=0;t<9;t++)l[e][t]=c[e][t];const r=W([...Array(81).keys()]);let s=0,o=0;for(let e of r){const t=Math.floor(e/9),i=e%9;if(c[t][i]===null)continue;const f=c[t][i];if(c[t][i]=null,L(c)!==1){c[t][i]=f;continue}const d=D(c,n);if(d==="fail"){c[t][i]=f,o++;continue}if(d==="tooHard"){c[t][i]=f,o++;continue}if(s++,n==="veryHard"){const a=E(M(c));if(!F(a))break}if(o>30)break}return s}function G(c,l){if(!c.solved)return!1;const n=c.score;switch(l){case"easy":return n<1.5;case"medium":return n>=1.5&&n<3.5;case"hard":return n>=3.5&&n<6;case"veryHard":return n>=6;default:return!1}}self.onmessage=c=>{const{type:l,difficulty:n}=c.data;try{if(l==="GENERATE"){const r=_(n);self.postMessage({type:"RESULT",result:r})}}catch(r){self.postMessage({type:"ERROR",error:r?.message??"generator error"})}}})();
