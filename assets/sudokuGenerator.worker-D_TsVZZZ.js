(function(){"use strict";function k(l){for(let i=l.length-1;i>0;i--){const o=Math.floor(Math.random()*(i+1));[l[i],l[o]]=[l[o],l[i]]}return l}function E(l){return l.map(i=>i.slice())}function B(l,i,o,c){for(let e=0;e<9;e++)if(l[i][e]===c||l[e][o]===c)return!1;const r=Math.floor(i/3)*3,n=Math.floor(o/3)*3;for(let e=r;e<r+3;e++)for(let t=n;t<n+3;t++)if(l[e][t]===c)return!1;return!0}const W={NakedSingle:.1,HiddenSingle:.2,NakedPair:1,NakedTriple:1.4,Pointing:1.2,Claiming:1.3,XWing:2.5,TwoStringKite:2.8,Skyscraper:3,WWing:3.2};function N(l,i,o){return{value:l,candidates:l?[]:[1,2,3,4,5,6,7,8,9],r:i,c:o}}function P(l){const i=l.map((o,c)=>o.map((r,n)=>N(r,c,n)));for(let o=0;o<9;o++)for(let c=0;c<9;c++)i[o][c].value&&w(i,o,c,i[o][c].value);return i}function v(l,i){const o=l.candidates.indexOf(i);return o!==-1?(l.candidates.splice(o,1),!0):!1}function w(l,i,o,c){for(let e=0;e<9;e++)e!==o&&v(l[i][e],c),e!==i&&v(l[e][o],c);const r=Math.floor(i/3)*3,n=Math.floor(o/3)*3;for(let e=r;e<r+3;e++)for(let t=n;t<n+3;t++)(e!==i||t!==o)&&v(l[e][t],c)}function T(l){let i=!1;for(let o=0;o<9;o++)for(let c=0;c<9;c++){const r=l[o][c];!r.value&&r.candidates.length===1&&(r.value=r.candidates[0],r.candidates=[],w(l,o,c,r.value),i=!0)}return i}function j(l){let i=!1;const o=c=>{for(let r=1;r<=9;r++){const n=c.filter(e=>!e.value&&e.candidates.includes(r));n.length===1&&(n[0].value=r,n[0].candidates=[],w(l,n[0].r,n[0].c,r),i=!0)}};for(let c=0;c<9;c++)o(l[c]),o(l.map(r=>r[c]));for(let c=0;c<9;c+=3)for(let r=0;r<9;r+=3){const n=[];for(let e=c;e<c+3;e++)for(let t=r;t<r+3;t++)n.push(l[e][t]);o(n)}return i}function R(l){let i=!1;const o=c=>{const r={};c.forEach(n=>{if(!n.value&&n.candidates.length===2){const e=n.candidates.join(",");r[e]=(r[e]||0)+1}});for(const n in r)if(r[n]===2){const e=n.split(",").map(Number);c.forEach(t=>{!t.value&&t.candidates.join(",")!==n&&e.forEach(s=>{t.candidates.includes(s)&&v(t,s)&&(i=!0)})})}};for(let c=0;c<9;c++)o(l[c]),o(l.map(r=>r[c]));for(let c=0;c<9;c+=3)for(let r=0;r<9;r+=3){const n=[];for(let e=c;e<c+3;e++)for(let t=r;t<r+3;t++)n.push(l[e][t]);o(n)}return i}function A(l){let i=!1;const o=c=>{const r=[];c.forEach(n=>{!n.value&&n.candidates.length>=2&&n.candidates.length<=3&&r.push(n)});for(let n=0;n<r.length;n++)for(let e=n+1;e<r.length;e++)for(let t=e+1;t<r.length;t++){const s=new Set([...r[n].candidates,...r[e].candidates,...r[t].candidates]);if(s.size===3){const f=[...s];c.forEach(a=>{a!==r[n]&&a!==r[e]&&a!==r[t]&&!a.value&&f.forEach(d=>{v(a,d)&&(i=!0)})})}}};for(let c=0;c<9;c++)o(l[c]),o(l.map(r=>r[c]));for(let c=0;c<9;c+=3)for(let r=0;r<9;r+=3){const n=[];for(let e=c;e<c+3;e++)for(let t=r;t<r+3;t++)n.push(l[e][t]);o(n)}return i}function x(l){let i=!1;for(let o=0;o<9;o+=3)for(let c=0;c<9;c+=3)for(let r=1;r<=9;r++){const n=[];for(let e=o;e<o+3;e++)for(let t=c;t<c+3;t++)!l[e][t].value&&l[e][t].candidates.includes(r)&&n.push({r:e,c:t});if(n.length===2||n.length===3){const e=n.every(s=>s.r===n[0].r),t=n.every(s=>s.c===n[0].c);if(e){const s=n[0].r;for(let f=0;f<9;f++)(f<c||f>=c+3)&&v(l[s][f],r)&&(i=!0)}if(t){const s=n[0].c;for(let f=0;f<9;f++)(f<o||f>=o+3)&&v(l[f][s],r)&&(i=!0)}}}return i}function z(l){let i=!1;for(let o=0;o<9;o++)for(let c=1;c<=9;c++){const r=[];for(let f=0;f<9;f++){const a=l[o][f];!a.value&&a.candidates.includes(c)&&r.push(a)}if(r.length<2)continue;const n=new Set(r.map(f=>Math.floor(f.c/3)));if(n.size!==1)continue;const e=[...n][0],t=Math.floor(o/3)*3,s=e*3;for(let f=t;f<t+3;f++)if(f!==o)for(let a=s;a<s+3;a++)v(l[f][a],c)&&(i=!0)}for(let o=0;o<9;o++)for(let c=1;c<=9;c++){const r=[];for(let f=0;f<9;f++){const a=l[f][o];!a.value&&a.candidates.includes(c)&&r.push(a)}if(r.length<2)continue;const n=new Set(r.map(f=>Math.floor(f.r/3)));if(n.size!==1)continue;const t=[...n][0]*3,s=Math.floor(o/3)*3;for(let f=t;f<t+3;f++)for(let a=s;a<s+3;a++)a!==o&&v(l[f][a],c)&&(i=!0)}return i}function H(l){let i=!1;for(let o=1;o<=9;o++){const c=[];for(let n=0;n<9;n++){const e=[];for(let t=0;t<9;t++){const s=l[n][t];!s.value&&s.candidates.includes(o)&&e.push(t)}e.length===2&&c.push({r:n,cols:e})}for(let n=0;n<c.length;n++)for(let e=n+1;e<c.length;e++){const t=c[n],s=c[e];if(t.cols[0]===s.cols[0]&&t.cols[1]===s.cols[1]){const f=t.cols[0],a=t.cols[1];for(let d=0;d<9;d++)d!==t.r&&d!==s.r&&(v(l[d][f],o)&&(i=!0),v(l[d][a],o)&&(i=!0))}}const r=[];for(let n=0;n<9;n++){const e=[];for(let t=0;t<9;t++){const s=l[t][n];!s.value&&s.candidates.includes(o)&&e.push(t)}e.length===2&&r.push({c:n,rows:e})}for(let n=0;n<r.length;n++)for(let e=n+1;e<r.length;e++){const t=r[n],s=r[e];if(t.rows[0]===s.rows[0]&&t.rows[1]===s.rows[1]){const f=t.rows[0],a=t.rows[1];for(let d=0;d<9;d++)d!==t.c&&d!==s.c&&(v(l[f][d],o)&&(i=!0),v(l[a][d],o)&&(i=!0))}}}return i}function X(l){let i=!1;for(let o=1;o<=9;o++){const c=[];for(let n=0;n<9;n++){const e=[];for(let t=0;t<9;t++){const s=l[n][t];!s.value&&s.candidates.includes(o)&&e.push({r:n,c:t})}e.length===2&&c.push(e)}const r=[];for(let n=0;n<9;n++){const e=[];for(let t=0;t<9;t++){const s=l[t][n];!s.value&&s.candidates.includes(o)&&e.push({r:t,c:n})}e.length===2&&r.push(e)}c.forEach(([n,e])=>{r.forEach(([t,s])=>{if(!(n.r===t.r&&n.c===t.c&&e.c!==s.c||n.r===s.r&&n.c===s.c&&e.c!==t.c||e.r===t.r&&e.c===t.c&&n.c!==s.c||e.r===s.r&&e.c===s.c&&n.c!==t.c))return;const a=n.r===t.r&&n.c===t.c?e:n,d=t.r===n.r&&t.c===n.c?s:t;for(let h=0;h<9;h++)for(let u=0;u<9;u++){const p=l[h][u];if(p.value||!p.candidates.includes(o))continue;const y=h===a.r||u===a.c||Math.floor(h/3)===Math.floor(a.r/3),S=h===d.r||u===d.c||Math.floor(u/3)===Math.floor(d.c/3);y&&S&&v(p,o)&&(i=!0)}})})}return i}function K(l){let i=!1;for(let o=1;o<=9;o++){const c=[];for(let n=0;n<9;n++){const e=[];for(let t=0;t<9;t++){const s=l[n][t];!s.value&&s.candidates.includes(o)&&e.push(t)}e.length===2&&c.push({r:n,cols:e})}for(let n=0;n<c.length;n++)for(let e=n+1;e<c.length;e++){const t=c[n],s=c[e],f=t.cols.filter(u=>s.cols.includes(u));if(f.length!==1)continue;const a=f[0],d=t.cols.find(u=>u!==a),h=s.cols.find(u=>u!==a);for(let u=0;u<9;u++)for(let p=0;p<9;p++){const y=l[u][p];if(y.value||!y.candidates.includes(o))continue;const S=u===t.r||p===d||Math.floor(u/3)===Math.floor(t.r/3),m=u===s.r||p===h||Math.floor(u/3)===Math.floor(s.r/3);S&&m&&v(y,o)&&(i=!0)}}const r=[];for(let n=0;n<9;n++){const e=[];for(let t=0;t<9;t++){const s=l[t][n];!s.value&&s.candidates.includes(o)&&e.push(t)}e.length===2&&r.push({c:n,rows:e})}for(let n=0;n<r.length;n++)for(let e=n+1;e<r.length;e++){const t=r[n],s=r[e],f=t.rows.filter(u=>s.rows.includes(u));if(f.length!==1)continue;const a=f[0],d=t.rows.find(u=>u!==a),h=s.rows.find(u=>u!==a);for(let u=0;u<9;u++)for(let p=0;p<9;p++){const y=l[u][p];if(y.value||!y.candidates.includes(o))continue;const S=u===d||p===t.c||Math.floor(p/3)===Math.floor(t.c/3),m=u===h||p===s.c||Math.floor(p/3)===Math.floor(s.c/3);S&&m&&v(y,o)&&(i=!0)}}}return i}function L(l){let i=!1;const o=[];for(let r=0;r<9;r++)for(let n=0;n<9;n++){const e=l[r][n];!e.value&&e.candidates.length===2&&o.push({r,c:n,nums:[...e.candidates]})}for(let r=0;r<o.length;r++)for(let n=r+1;n<o.length;n++){const e=o[r],t=o[n];if(e.nums[0]!==t.nums[0]||e.nums[1]!==t.nums[1])continue;const s=e.r===t.r,f=e.c===t.c,a=Math.floor(e.r/3)===Math.floor(t.r/3)&&Math.floor(e.c/3)===Math.floor(t.c/3);if(s||f||a)continue;const[d,h]=e.nums;[d,h].forEach(u=>{for(let m=0;m<9;m++){const g=[];for(let M=0;M<9;M++)!l[m][M].value&&l[m][M].candidates.includes(u)&&g.push({r:m,c:M});g.length===2&&(g[0].r===e.r&&g[0].c===e.c&&g[1].r===t.r&&g[1].c===t.c||g[1].r===e.r&&g[1].c===e.c&&g[0].r===t.r&&g[0].c===t.c)&&c(l,e,t,d,h,u)}for(let m=0;m<9;m++){const g=[];for(let M=0;M<9;M++)!l[M][m].value&&l[M][m].candidates.includes(u)&&g.push({r:M,c:m});g.length===2&&(g[0].r===e.r&&g[0].c===e.c&&g[1].r===t.r&&g[1].c===t.c||g[1].r===e.r&&g[1].c===e.c&&g[0].r===t.r&&g[0].c===t.c)&&c(l,e,t,d,h,u)}const p=Math.floor(e.r/3)*3,y=Math.floor(e.c/3)*3,S=[];for(let m=p;m<p+3;m++)for(let g=y;g<y+3;g++)!l[m][g].value&&l[m][g].candidates.includes(u)&&S.push({r:m,c:g});S.length===2&&(S[0].r===e.r&&S[0].c===e.c&&S[1].r===t.r&&S[1].c===t.c||S[1].r===e.r&&S[1].c===e.c&&S[0].r===t.r&&S[0].c===t.c)&&c(l,e,t,d,h,u)})}function c(r,n,e,t,s,f){const a=f===t?s:t;for(let d=0;d<9;d++)for(let h=0;h<9;h++){const u=r[d][h];if(u.value||!u.candidates.includes(a))continue;const p=d===n.r||h===n.c||Math.floor(d/3)===Math.floor(n.r/3),y=d===e.r||h===e.c||Math.floor(d/3)===Math.floor(e.r/3);p&&y&&v(u,a)&&(i=!0)}}return i}function U(l){return l.map(i=>i.map(o=>o.value?o.value:`(${o.candidates.join("")})`).join(",")).join("|")}function D(l){const i=P(l),o={NakedSingle:0,HiddenSingle:0,NakedPair:0,NakedTriple:0,Pointing:0,Claiming:0,XWing:0,TwoStringKite:0,Skyscraper:0,WWing:0};let c="";for(;;){const a=U(i);if(a===c)break;if(c=a,T(i)){o.NakedSingle++;continue}if(j(i)){o.HiddenSingle++;continue}if(R(i)){o.NakedPair++;continue}if(A(i)){o.NakedTriple++;continue}if(x(i)){o.Pointing++;continue}if(z(i)){o.Claiming++;continue}if(H(i)){o.XWing++;continue}if(X(i)){o.TwoStringKite++;continue}if(K(i)){o.Skyscraper++;continue}if(L(i)){o.WWing++;continue}break}const r=["NakedSingle","HiddenSingle","NakedPair","NakedTriple","Pointing","Claiming","XWing","TwoStringKite","Skyscraper","WWing"];let n=null;for(let a=r.length-1;a>=0;a--)if(o[r[a]]){n=r[a];break}function e(a){let d=0;for(const h in a)d+=a[h]*(W[h]||0);return Number(d.toFixed(2))}const t=i.every(a=>a.every(d=>d.value));let s=!1,f=null;if(!t){const a=i.some(h=>h.some(u=>!u.value));i.some(h=>h.some(u=>!u.value&&u.candidates.length===0))?(s=!0,f="contradiction"):a&&(s=!0,f="noMoreLogicalMoves")}return{solved:t,stalled:s,stallReason:f,techniquesUsed:o,maxTechnique:n,score:e(o)}}function C(l){for(let i=0;i<9;i++)for(let o=0;o<9;o++)if(l[i][o]===null){const c=k([1,2,3,4,5,6,7,8,9]);for(let r of c)if(B(l,i,o,r)){if(l[i][o]=r,C(l))return!0;l[i][o]=null}return!1}return!0}function I(l,i=2){let o=0,c=0;const r=2e4;function n(e){if(++c>r){o=i;return}if(!(o>=i)){for(let t=0;t<9;t++)for(let s=0;s<9;s++)if(e[t][s]===null){for(let f=1;f<=9;f++)B(e,t,s,f)&&(e[t][s]=f,n(e),e[t][s]=null);return}o++}}return n(E(l)),o}function O({board:l,solution:i}){C(l);for(let c=0;c<9;c++)for(let r=0;r<9;r++)i[c][r]=l[c][r];const o=k([...Array(81).keys()]);for(let c of o){const r=Math.floor(c/9),n=c%9,e=l[r][n];if(l[r][n]=null,I(l)!==1){l[r][n]=e;continue}}}function _(l){const i=E(l);return D(i)}function F(l,i){if(!l.solved)return!1;const o=l.score;switch(i){case"easy":return o<1.5;case"medium":return o>=1.5&&o<3.5;case"hard":return o>=3.5&&o<6;case"veryHard":return o>=6;default:return!1}}function G(l){let i=0;for(;i<200;){i++;const o=Array.from({length:9},()=>Array(9).fill(null)),c=Array.from({length:9},()=>Array(9).fill(null));O({board:o,solution:c});const r=_(o);if(F(r,l))return console.log("퍼즐 생성 성공",r),{puzzle:o,solution:c}}if(i>=200)return console.log("퍼즐 생성 실패 → fallback"),null}self.onmessage=l=>{const{type:i,difficulty:o}=l.data;try{if(i==="GENERATE"){const c=G(o);self.postMessage({type:"RESULT",result:c})}}catch(c){self.postMessage({type:"ERROR",error:c?.message??"generator error"})}}})();
