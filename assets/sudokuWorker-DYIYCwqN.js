(function(){"use strict";function m(i){for(let o=i.length-1;o>0;o--){const t=Math.floor(Math.random()*(o+1));[i[o],i[t]]=[i[t],i[o]]}return i}function S(i){return i.map(o=>o.slice())}function v(i,o,t,n){for(let l=0;l<9;l++)if(i[o][l]===n||i[l][t]===n)return!1;const e=Math.floor(o/3)*3,r=Math.floor(t/3)*3;for(let l=e;l<e+3;l++)for(let c=r;c<r+3;c++)if(i[l][c]===n)return!1;return!0}const k={NakedSingle:.1,HiddenSingle:.2,NakedPair:1,NakedTriple:1.4,Pointing:1.2,Claiming:1.3,XWing:2.5,SimpleColoring:3};function N(i,o,t){return{value:i,candidates:i?[]:[1,2,3,4,5,6,7,8,9],r:o,c:t}}function C(i){const o=i.map((t,n)=>t.map((e,r)=>N(e,n,r)));for(let t=0;t<9;t++)for(let n=0;n<9;n++)o[t][n].value&&p(o,t,n,o[t][n].value);return o}function u(i,o){const t=i.candidates.indexOf(o);return t!==-1?(i.candidates.splice(t,1),!0):!1}function p(i,o,t,n){for(let l=0;l<9;l++)l!==t&&u(i[o][l],n),l!==o&&u(i[l][t],n);const e=Math.floor(o/3)*3,r=Math.floor(t/3)*3;for(let l=e;l<e+3;l++)for(let c=r;c<r+3;c++)(l!==o||c!==t)&&u(i[l][c],n)}function E(i){let o=!1;for(let t=0;t<9;t++)for(let n=0;n<9;n++){const e=i[t][n];!e.value&&e.candidates.length===1&&(e.value=e.candidates[0],e.candidates=[],p(i,t,n,e.value),o=!0)}return o}function M(i){let o=!1;const t=n=>{for(let e=1;e<=9;e++){const r=n.filter(l=>!l.value&&l.candidates.includes(e));r.length===1&&(r[0].value=e,r[0].candidates=[],p(i,r[0].r,r[0].c,e),o=!0)}};for(let n=0;n<9;n++)t(i[n]),t(i.map(e=>e[n]));for(let n=0;n<9;n+=3)for(let e=0;e<9;e+=3){const r=[];for(let l=n;l<n+3;l++)for(let c=e;c<e+3;c++)r.push(i[l][c]);t(r)}return o}function P(i){let o=!1;const t=n=>{const e={};n.forEach(r=>{if(!r.value&&r.candidates.length===2){const l=r.candidates.join(",");e[l]=(e[l]||0)+1}});for(const r in e)if(e[r]===2){const l=r.split(",").map(Number);n.forEach(c=>{!c.value&&c.candidates.join(",")!==r&&l.forEach(f=>{c.candidates.includes(f)&&u(c,f)&&(o=!0)})})}};for(let n=0;n<9;n++)t(i[n]),t(i.map(e=>e[n]));for(let n=0;n<9;n+=3)for(let e=0;e<9;e+=3){const r=[];for(let l=n;l<n+3;l++)for(let c=e;c<e+3;c++)r.push(i[l][c]);t(r)}return o}function B(i){let o=!1;const t=n=>{const e=[];n.forEach(r=>{!r.value&&r.candidates.length>=2&&r.candidates.length<=3&&e.push(r)});for(let r=0;r<e.length;r++)for(let l=r+1;l<e.length;l++)for(let c=l+1;c<e.length;c++){const f=new Set([...e[r].candidates,...e[l].candidates,...e[c].candidates]);if(f.size===3){const s=[...f];n.forEach(a=>{a!==e[r]&&a!==e[l]&&a!==e[c]&&!a.value&&s.forEach(d=>{u(a,d)&&(o=!0)})})}}};for(let n=0;n<9;n++)t(i[n]),t(i.map(e=>e[n]));for(let n=0;n<9;n+=3)for(let e=0;e<9;e+=3){const r=[];for(let l=n;l<n+3;l++)for(let c=e;c<e+3;c++)r.push(i[l][c]);t(r)}return o}function x(i){let o=!1;for(let t=0;t<9;t+=3)for(let n=0;n<9;n+=3)for(let e=1;e<=9;e++){const r=[];for(let l=t;l<t+3;l++)for(let c=n;c<n+3;c++)!i[l][c].value&&i[l][c].candidates.includes(e)&&r.push({r:l,c});if(r.length>1){const l=r.every(f=>f.r===r[0].r),c=r.every(f=>f.c===r[0].c);if(l){const f=r[0].r;for(let s=0;s<9;s++)(s<n||s>=n+3)&&u(i[f][s],e)&&(o=!0)}if(c){const f=r[0].c;for(let s=0;s<9;s++)(s<t||s>=t+3)&&u(i[s][f],e)&&(o=!0)}}}return o}function T(i){let o=!1;for(let t=0;t<9;t++)for(let n=1;n<=9;n++){const e=[];for(let s=0;s<9;s++){const a=i[t][s];!a.value&&a.candidates.includes(n)&&e.push(a)}if(e.length<2)continue;const r=new Set(e.map(s=>Math.floor(s.c/3)));if(r.size!==1)continue;const l=[...r][0],c=Math.floor(t/3)*3,f=l*3;for(let s=c;s<c+3;s++)if(s!==t)for(let a=f;a<f+3;a++)u(i[s][a],n)&&(o=!0)}for(let t=0;t<9;t++)for(let n=1;n<=9;n++){const e=[];for(let s=0;s<9;s++){const a=i[s][t];!a.value&&a.candidates.includes(n)&&e.push(a)}if(e.length<2)continue;const r=new Set(e.map(s=>Math.floor(s.r/3)));if(r.size!==1)continue;const c=[...r][0]*3,f=Math.floor(t/3)*3;for(let s=c;s<c+3;s++)for(let a=f;a<f+3;a++)a!==t&&u(i[s][a],n)&&(o=!0)}return o}function j(i){let o=!1;for(let t=1;t<=9;t++){const n=[];for(let e=0;e<9;e++){const r=[];for(let l=0;l<9;l++)!i[e][l].value&&i[e][l].candidates.includes(t)&&r.push(l);r.length===2&&n.push({r:e,cols:r})}for(let e=0;e<n.length;e++)for(let r=e+1;r<n.length;r++)if(n[e].cols[0]===n[r].cols[0]&&n[e].cols[1]===n[r].cols[1]){const[l,c]=n[e].cols;for(let f=0;f<9;f++)f!==n[e].r&&f!==n[r].r&&(u(i[f][l],t)&&(o=!0),u(i[f][c],t)&&(o=!0))}}return o}function z(i){let o=!1;for(let t=1;t<=9;t++){const n=[];for(let e=0;e<9;e++){const r=[];for(let l=0;l<9;l++)!i[e][l].value&&i[e][l].candidates.includes(t)&&r.push(i[e][l]);r.length===2&&n.push(r)}n.forEach(([e,r])=>{for(let l=0;l<9;l++)for(let c=0;c<9;c++){const f=i[l][c];f!==e&&f!==r&&f.candidates.includes(t)&&(f.r===e.r||f.c===e.c)&&u(f,t)&&(o=!0)}})}return o}function H(i){return i.map(o=>o.map(t=>t.value?t.value:`(${t.candidates.join("")})`).join(",")).join("|")}function A(i){const o=C(i),t={NakedSingle:0,HiddenSingle:0,NakedPair:0,NakedTriple:0,Pointing:0,Claiming:0,XWing:0,SimpleColoring:0};let n="";for(;;){const a=H(o);if(a===n)break;if(n=a,E(o)){t.NakedSingle++;continue}if(M(o)){t.HiddenSingle++;continue}if(P(o)){t.NakedPair++;continue}if(B(o)){t.NakedTriple++;continue}if(x(o)){t.Pointing++;continue}if(T(o)){t.Claiming++;continue}if(j(o)){t.XWing++;continue}if(z(o)){t.SimpleColoring++;continue}break}const e=["NakedSingle","HiddenSingle","NakedPair","NakedTriple","Pointing","Claiming","XWing","SimpleColoring"];let r=null;for(let a=e.length-1;a>=0;a--)if(t[e[a]]){r=e[a];break}function l(a){let d=0;for(const g in a)d+=a[g]*(k[g]||0);return Number(d.toFixed(2))}const c=o.every(a=>a.every(d=>d.value));let f=!1,s=null;if(!c){const a=o.some(g=>g.some(h=>!h.value));o.some(g=>g.some(h=>!h.value&&h.candidates.length===0))?(f=!0,s="contradiction"):a&&(f=!0,s="noMoreLogicalMoves")}return{solved:c,stalled:f,stallReason:s,techniquesUsed:t,maxTechnique:r,score:l(t)}}function y(i){for(let o=0;o<9;o++)for(let t=0;t<9;t++)if(i[o][t]===null){const n=m([1,2,3,4,5,6,7,8,9]);for(let e of n)if(v(i,o,t,e)){if(i[o][t]=e,y(i))return!0;i[o][t]=null}return!1}return!0}function W(i,o=2){let t=0,n=0;const e=2e4;function r(l){if(++n>e){t=o;return}if(!(t>=o)){for(let c=0;c<9;c++)for(let f=0;f<9;f++)if(l[c][f]===null){for(let s=1;s<=9;s++)v(l,c,f,s)&&(l[c][f]=s,r(l),l[c][f]=null);return}t++}}return r(S(i)),t}function X({board:i,solution:o}){y(i);for(let n=0;n<9;n++)for(let e=0;e<9;e++)o[n][e]=i[n][e];const t=m([...Array(81).keys()]);for(let n of t){const e=Math.floor(n/9),r=n%9,l=i[e][r];if(i[e][r]=null,W(i)!==1){i[e][r]=l;continue}}}function w(i){const o=S(i);return A(o)}function R(i,o){if(!i.solved)return!1;const t=i.score;switch(o){case"easy":return t<1.5;case"medium":return t>=1.5&&t<3.5;case"hard":return t>=3.5&&t<6;case"veryHard":return t>=6;default:return!1}}function U(i){let o=0;for(;o<200;){o++;const t=Array.from({length:9},()=>Array(9).fill(null)),n=Array.from({length:9},()=>Array(9).fill(null));X({board:t,solution:n});const e=w(t);if(R(e,i))return console.log("퍼즐 생성 성공",e),{puzzle:t,solution:n};console.log("퍼즐 생성 실패 난이도 조건 미달",e)}if(o>=200)return console.log("퍼즐 생성 실패 → fallback"),null}self.onmessage=i=>{const{type:o,difficulty:t}=i.data;if(console.log("type",o),console.log("difficulty",t),o==="GENERATE"){const n=U(t);self.postMessage({type:"RESULT",result:n})}}})();
