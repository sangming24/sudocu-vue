(function(){"use strict";function W(r){for(let l=r.length-1;l>0;l--){const n=Math.floor(Math.random()*(l+1));[r[l],r[n]]=[r[n],r[l]]}return r}function M(r){return r.map(l=>l.slice())}function E(r,l,n,s){for(let t=0;t<9;t++)if(r[l][t]===s||r[t][n]===s)return!1;const c=Math.floor(l/3)*3,o=Math.floor(n/3)*3;for(let t=c;t<c+3;t++)for(let e=o;e<o+3;e++)if(r[t][e]===s)return!1;return!0}const T={NakedSingle:.1,HiddenSingle:.2,NakedPair:1,NakedTriple:1.4,Pointing:1.2,Claiming:1.3,XWing:2.5,TwoStringKite:2.8,Skyscraper:3,WWing:3.2};function N(r,l,n){return{value:r,candidates:r?[]:[1,2,3,4,5,6,7,8,9],r:l,c:n}}function C(r){const l=r.map((n,s)=>n.map((c,o)=>N(c,s,o)));for(let n=0;n<9;n++)for(let s=0;s<9;s++)l[n][s].value&&w(l,n,s,l[n][s].value);return l}function v(r,l){const n=r.candidates.indexOf(l);return n!==-1?(r.candidates.splice(n,1),!0):!1}function w(r,l,n,s){for(let t=0;t<9;t++)t!==n&&v(r[l][t],s),t!==l&&v(r[t][n],s);const c=Math.floor(l/3)*3,o=Math.floor(n/3)*3;for(let t=c;t<c+3;t++)for(let e=o;e<o+3;e++)(t!==l||e!==n)&&v(r[t][e],s)}function P(r){let l=!1;for(let n=0;n<9;n++)for(let s=0;s<9;s++){const c=r[n][s];!c.value&&c.candidates.length===1&&(c.value=c.candidates[0],c.candidates=[],w(r,n,s,c.value),l=!0)}return l}function B(r){let l=!1;const n=s=>{for(let c=1;c<=9;c++){const o=s.filter(t=>!t.value&&t.candidates.includes(c));o.length===1&&(o[0].value=c,o[0].candidates=[],w(r,o[0].r,o[0].c,c),l=!0)}};for(let s=0;s<9;s++)n(r[s]),n(r.map(c=>c[s]));for(let s=0;s<9;s+=3)for(let c=0;c<9;c+=3){const o=[];for(let t=s;t<s+3;t++)for(let e=c;e<c+3;e++)o.push(r[t][e]);n(o)}return l}function A(r){let l=!1;const n=s=>{const c={};s.forEach(o=>{if(!o.value&&o.candidates.length===2){const t=o.candidates.join(",");c[t]=(c[t]||0)+1}});for(const o in c)if(c[o]===2){const t=o.split(",").map(Number);s.forEach(e=>{!e.value&&e.candidates.join(",")!==o&&t.forEach(i=>{e.candidates.includes(i)&&v(e,i)&&(l=!0)})})}};for(let s=0;s<9;s++)n(r[s]),n(r.map(c=>c[s]));for(let s=0;s<9;s+=3)for(let c=0;c<9;c+=3){const o=[];for(let t=s;t<s+3;t++)for(let e=c;e<c+3;e++)o.push(r[t][e]);n(o)}return l}function R(r){let l=!1;const n=s=>{const c=[];s.forEach(o=>{!o.value&&o.candidates.length>=2&&o.candidates.length<=3&&c.push(o)});for(let o=0;o<c.length;o++)for(let t=o+1;t<c.length;t++)for(let e=t+1;e<c.length;e++){const i=new Set([...c[o].candidates,...c[t].candidates,...c[e].candidates]);if(i.size===3){const f=[...i];s.forEach(d=>{d!==c[o]&&d!==c[t]&&d!==c[e]&&!d.value&&f.forEach(a=>{v(d,a)&&(l=!0)})})}}};for(let s=0;s<9;s++)n(r[s]),n(r.map(c=>c[s]));for(let s=0;s<9;s+=3)for(let c=0;c<9;c+=3){const o=[];for(let t=s;t<s+3;t++)for(let e=c;e<c+3;e++)o.push(r[t][e]);n(o)}return l}function H(r){let l=!1;for(let n=0;n<9;n+=3)for(let s=0;s<9;s+=3)for(let c=1;c<=9;c++){const o=[];for(let t=n;t<n+3;t++)for(let e=s;e<s+3;e++)!r[t][e].value&&r[t][e].candidates.includes(c)&&o.push({r:t,c:e});if(o.length===2||o.length===3){const t=o.every(i=>i.r===o[0].r),e=o.every(i=>i.c===o[0].c);if(t){const i=o[0].r;for(let f=0;f<9;f++)(f<s||f>=s+3)&&v(r[i][f],c)&&(l=!0)}if(e){const i=o[0].c;for(let f=0;f<9;f++)(f<n||f>=n+3)&&v(r[f][i],c)&&(l=!0)}}}return l}function x(r){let l=!1;for(let n=0;n<9;n++)for(let s=1;s<=9;s++){const c=[];for(let f=0;f<9;f++){const d=r[n][f];!d.value&&d.candidates.includes(s)&&c.push(d)}if(c.length<2)continue;const o=new Set(c.map(f=>Math.floor(f.c/3)));if(o.size!==1)continue;const t=[...o][0],e=Math.floor(n/3)*3,i=t*3;for(let f=e;f<e+3;f++)if(f!==n)for(let d=i;d<i+3;d++)v(r[f][d],s)&&(l=!0)}for(let n=0;n<9;n++)for(let s=1;s<=9;s++){const c=[];for(let f=0;f<9;f++){const d=r[f][n];!d.value&&d.candidates.includes(s)&&c.push(d)}if(c.length<2)continue;const o=new Set(c.map(f=>Math.floor(f.r/3)));if(o.size!==1)continue;const e=[...o][0]*3,i=Math.floor(n/3)*3;for(let f=e;f<e+3;f++)for(let d=i;d<i+3;d++)d!==n&&v(r[f][d],s)&&(l=!0)}return l}function X(r){let l=!1;for(let n=1;n<=9;n++){const s=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[o][e];!i.value&&i.candidates.includes(n)&&t.push(e)}t.length===2&&s.push({r:o,cols:t})}for(let o=0;o<s.length;o++)for(let t=o+1;t<s.length;t++){const e=s[o],i=s[t];if(e.cols[0]===i.cols[0]&&e.cols[1]===i.cols[1]){const f=e.cols[0],d=e.cols[1];for(let a=0;a<9;a++)a!==e.r&&a!==i.r&&(v(r[a][f],n)&&(l=!0),v(r[a][d],n)&&(l=!0))}}const c=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[e][o];!i.value&&i.candidates.includes(n)&&t.push(e)}t.length===2&&c.push({c:o,rows:t})}for(let o=0;o<c.length;o++)for(let t=o+1;t<c.length;t++){const e=c[o],i=c[t];if(e.rows[0]===i.rows[0]&&e.rows[1]===i.rows[1]){const f=e.rows[0],d=e.rows[1];for(let a=0;a<9;a++)a!==e.c&&a!==i.c&&(v(r[f][a],n)&&(l=!0),v(r[d][a],n)&&(l=!0))}}}return l}function j(r){let l=!1;for(let n=1;n<=9;n++){const s=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[o][e];!i.value&&i.candidates.includes(n)&&t.push({r:o,c:e})}t.length===2&&s.push(t)}const c=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[e][o];!i.value&&i.candidates.includes(n)&&t.push({r:e,c:o})}t.length===2&&c.push(t)}s.forEach(([o,t])=>{c.forEach(([e,i])=>{if(!(o.r===e.r&&o.c===e.c&&t.c!==i.c||o.r===i.r&&o.c===i.c&&t.c!==e.c||t.r===e.r&&t.c===e.c&&o.c!==i.c||t.r===i.r&&t.c===i.c&&o.c!==e.c))return;const d=o.r===e.r&&o.c===e.c?t:o,a=e.r===o.r&&e.c===o.c?i:e;for(let h=0;h<9;h++)for(let u=0;u<9;u++){const g=r[h][u];if(g.value||!g.candidates.includes(n))continue;const y=h===d.r||u===d.c||Math.floor(h/3)===Math.floor(d.r/3),S=h===a.r||u===a.c||Math.floor(u/3)===Math.floor(a.c/3);y&&S&&v(g,n)&&(l=!0)}})})}return l}function z(r){let l=!1;for(let n=1;n<=9;n++){const s=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[o][e];!i.value&&i.candidates.includes(n)&&t.push(e)}t.length===2&&s.push({r:o,cols:t})}for(let o=0;o<s.length;o++)for(let t=o+1;t<s.length;t++){const e=s[o],i=s[t],f=e.cols.filter(u=>i.cols.includes(u));if(f.length!==1)continue;const d=f[0],a=e.cols.find(u=>u!==d),h=i.cols.find(u=>u!==d);for(let u=0;u<9;u++)for(let g=0;g<9;g++){const y=r[u][g];if(y.value||!y.candidates.includes(n))continue;const S=u===e.r||g===a||Math.floor(u/3)===Math.floor(e.r/3),m=u===i.r||g===h||Math.floor(u/3)===Math.floor(i.r/3);S&&m&&v(y,n)&&(l=!0)}}const c=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[e][o];!i.value&&i.candidates.includes(n)&&t.push(e)}t.length===2&&c.push({c:o,rows:t})}for(let o=0;o<c.length;o++)for(let t=o+1;t<c.length;t++){const e=c[o],i=c[t],f=e.rows.filter(u=>i.rows.includes(u));if(f.length!==1)continue;const d=f[0],a=e.rows.find(u=>u!==d),h=i.rows.find(u=>u!==d);for(let u=0;u<9;u++)for(let g=0;g<9;g++){const y=r[u][g];if(y.value||!y.candidates.includes(n))continue;const S=u===a||g===e.c||Math.floor(g/3)===Math.floor(e.c/3),m=u===h||g===i.c||Math.floor(g/3)===Math.floor(i.c/3);S&&m&&v(y,n)&&(l=!0)}}}return l}function K(r){let l=!1;const n=[];for(let c=0;c<9;c++)for(let o=0;o<9;o++){const t=r[c][o];!t.value&&t.candidates.length===2&&n.push({r:c,c:o,nums:[...t.candidates]})}for(let c=0;c<n.length;c++)for(let o=c+1;o<n.length;o++){const t=n[c],e=n[o];if(t.nums[0]!==e.nums[0]||t.nums[1]!==e.nums[1])continue;const i=t.r===e.r,f=t.c===e.c,d=Math.floor(t.r/3)===Math.floor(e.r/3)&&Math.floor(t.c/3)===Math.floor(e.c/3);if(i||f||d)continue;const[a,h]=t.nums;[a,h].forEach(u=>{for(let m=0;m<9;m++){const p=[];for(let k=0;k<9;k++)!r[m][k].value&&r[m][k].candidates.includes(u)&&p.push({r:m,c:k});p.length===2&&(p[0].r===t.r&&p[0].c===t.c&&p[1].r===e.r&&p[1].c===e.c||p[1].r===t.r&&p[1].c===t.c&&p[0].r===e.r&&p[0].c===e.c)&&s(r,t,e,a,h,u)}for(let m=0;m<9;m++){const p=[];for(let k=0;k<9;k++)!r[k][m].value&&r[k][m].candidates.includes(u)&&p.push({r:k,c:m});p.length===2&&(p[0].r===t.r&&p[0].c===t.c&&p[1].r===e.r&&p[1].c===e.c||p[1].r===t.r&&p[1].c===t.c&&p[0].r===e.r&&p[0].c===e.c)&&s(r,t,e,a,h,u)}const g=Math.floor(t.r/3)*3,y=Math.floor(t.c/3)*3,S=[];for(let m=g;m<g+3;m++)for(let p=y;p<y+3;p++)!r[m][p].value&&r[m][p].candidates.includes(u)&&S.push({r:m,c:p});S.length===2&&(S[0].r===t.r&&S[0].c===t.c&&S[1].r===e.r&&S[1].c===e.c||S[1].r===t.r&&S[1].c===t.c&&S[0].r===e.r&&S[0].c===e.c)&&s(r,t,e,a,h,u)})}function s(c,o,t,e,i,f){const d=f===e?i:e;for(let a=0;a<9;a++)for(let h=0;h<9;h++){const u=c[a][h];if(u.value||!u.candidates.includes(d))continue;const g=a===o.r||h===o.c||Math.floor(a/3)===Math.floor(o.r/3),y=a===t.r||h===t.c||Math.floor(a/3)===Math.floor(t.r/3);g&&y&&v(u,d)&&(l=!0)}}return l}function U(r){const l=C(r),n={NakedSingle:0,HiddenSingle:0,NakedPair:0,NakedTriple:0,Pointing:0,Claiming:0,XWing:0,TwoStringKite:0,Skyscraper:0,WWing:0};let s=0;const c=500;for(;s++<c;){let a=!1;if(P(l)?(n.NakedSingle++,a=!0):B(l)?(n.HiddenSingle++,a=!0):A(l)?(n.NakedPair++,a=!0):R(l)?(n.NakedTriple++,a=!0):H(l)?(n.Pointing++,a=!0):x(l)?(n.Claiming++,a=!0):X(l)?(n.XWing++,a=!0):j(l)?(n.TwoStringKite++,a=!0):z(l)?(n.Skyscraper++,a=!0):K(l)&&(n.WWing++,a=!0),!a)break}const o=["NakedSingle","HiddenSingle","NakedPair","NakedTriple","Pointing","Claiming","XWing","TwoStringKite","Skyscraper","WWing"];let t=null;for(let a=o.length-1;a>=0;a--)if(n[o[a]]){t=o[a];break}function e(a){let h=0;for(const u in a)h+=a[u]*(T[u]||0);return Number(h.toFixed(2))}const i=l.every(a=>a.every(h=>h.value));let f=!1,d=null;if(!i){const a=l.some(u=>u.some(g=>!g.value));l.some(u=>u.some(g=>!g.value&&g.candidates.length===0))?(f=!0,d="contradiction"):a&&(f=!0,d="noMoreLogicalMoves")}return{solved:i,stalled:f,stallReason:d,techniquesUsed:n,maxTechnique:t,score:e(n)}}function q(r){for(let l=0;l<9;l++)for(let n=0;n<9;n++)if(r[l][n]===null){const s=W([1,2,3,4,5,6,7,8,9]);for(let c of s)if(E(r,l,n,c)){if(r[l][n]=c,q(r))return!0;r[l][n]=null}return!1}return!0}function I(r,l=2){let n=0,s=0;const c=2e4;function o(t){if(++s>c){n=l;return}if(!(n>=l)){for(let e=0;e<9;e++)for(let i=0;i<9;i++)if(t[e][i]===null){for(let f=1;f<=9;f++)E(t,e,i,f)&&(t[e][i]=f,o(t),t[e][i]=null);return}n++}}return o(M(r)),n}function L(r,l){const n=U(M(r));if(!n.solved&&n.stalled)return"fail";const s=n.techniquesUsed.NakedSingle+n.techniquesUsed.HiddenSingle,c=n.techniquesUsed.XWing+n.techniquesUsed.TwoStringKite+n.techniquesUsed.Skyscraper+n.techniquesUsed.WWing>0;return l==="easy"&&n.techniquesUsed.NakedPair+n.techniquesUsed.NakedTriple+n.techniquesUsed.Pointing+n.techniquesUsed.Claiming+n.techniquesUsed.XWing+n.techniquesUsed.TwoStringKite+n.techniquesUsed.Skyscraper+n.techniquesUsed.WWing>0?"tooHard":l==="medium"&&s>30||l==="hard"&&s>20||l==="veryHard"&&(s>15||!c&&s>10)?"tooEasy":"ok"}function _(r){return r.techniquesUsed.XWing+r.techniquesUsed.TwoStringKite+r.techniquesUsed.Skyscraper+r.techniquesUsed.WWing>0}function D(r){const l=M(r);return U(l)}function F(r){let l=0;const n=r==="veryHard"?300:200,s=performance.now();for(;l<n;){l++;const c=Array.from({length:9},()=>Array(9).fill(null)),o=Array.from({length:9},()=>Array(9).fill(null)),t=O({board:c,solution:o,difficulty:r}),e=D(c);if(G(e,r)){if(r==="veryHard"&&e.techniquesUsed.NakedPair+e.techniquesUsed.NakedTriple+e.techniquesUsed.Pointing+e.techniquesUsed.Claiming+e.techniquesUsed.XWing+e.techniquesUsed.TwoStringKite+e.techniquesUsed.Skyscraper+e.techniquesUsed.WWing<2)continue;const i=performance.now();return console.log("생성 시간 : ",((i-s)/1e3).toFixed(3),"s, 시도 횟수 : ",l," 빈칸 수 : ",t),console.log("퍼즐 생성 성공",e),{puzzle:c,solution:o}}}if(l>=200){const c=performance.now();return console.log("생성 시간 : ",((c-s)/1e3).toFixed(3),"s"),console.log("퍼즐 생성 실패 → fallback"),null}}function O({board:r,solution:l,difficulty:n}){q(r);for(let t=0;t<9;t++)for(let e=0;e<9;e++)l[t][e]=r[t][e];const s=W([...Array(81).keys()]);let c=0,o=0;for(let t of s){const e=Math.floor(t/9),i=t%9;if(r[e][i]===null)continue;const f=r[e][i];if(r[e][i]=null,I(r)!==1){r[e][i]=f;continue}const d=L(r,n);if(d==="fail"){r[e][i]=f,o++;continue}if(d==="tooHard"){r[e][i]=f,o++;continue}if(c++,n==="veryHard"&&c>=45){const a=U(M(r));if(_(a))break}if(o>30)break}return c}function G(r,l){if(!r.solved)return!1;const n=r.score;switch(l){case"easy":return n<1.5;case"medium":return n>=1.5&&n<3.5;case"hard":return n>=3.5&&n<6;case"veryHard":return n>=6;default:return!1}}self.onmessage=r=>{const{type:l,difficulty:n}=r.data;try{if(l==="GENERATE"){const s=F(n);self.postMessage({type:"RESULT",result:s})}}catch(s){self.postMessage({type:"ERROR",error:s?.message??"generator error"})}}})();
