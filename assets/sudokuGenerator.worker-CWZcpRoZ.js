(function(){"use strict";function U(r){for(let l=r.length-1;l>0;l--){const n=Math.floor(Math.random()*(l+1));[r[l],r[n]]=[r[n],r[l]]}return r}function M(r){return r.map(l=>l.slice())}function W(r,l,n,c){for(let t=0;t<9;t++)if(r[l][t]===c||r[t][n]===c)return!1;const s=Math.floor(l/3)*3,o=Math.floor(n/3)*3;for(let t=s;t<s+3;t++)for(let e=o;e<o+3;e++)if(r[t][e]===c)return!1;return!0}const T={NakedSingle:.1,HiddenSingle:.2,NakedPair:1,NakedTriple:1.4,Pointing:1.2,Claiming:1.3,XWing:2.5,TwoStringKite:2.8,Skyscraper:3,WWing:3.2};function B(r,l,n){return{value:r,candidates:r?[]:[1,2,3,4,5,6,7,8,9],r:l,c:n}}function N(r){const l=r.map((n,c)=>n.map((s,o)=>B(s,c,o)));for(let n=0;n<9;n++)for(let c=0;c<9;c++)l[n][c].value&&w(l,n,c,l[n][c].value);return l}function v(r,l){const n=r.candidates.indexOf(l);return n!==-1?(r.candidates.splice(n,1),!0):!1}function w(r,l,n,c){for(let t=0;t<9;t++)t!==n&&v(r[l][t],c),t!==l&&v(r[t][n],c);const s=Math.floor(l/3)*3,o=Math.floor(n/3)*3;for(let t=s;t<s+3;t++)for(let e=o;e<o+3;e++)(t!==l||e!==n)&&v(r[t][e],c)}function A(r){let l=!1;for(let n=0;n<9;n++)for(let c=0;c<9;c++){const s=r[n][c];!s.value&&s.candidates.length===1&&(s.value=s.candidates[0],s.candidates=[],w(r,n,c,s.value),l=!0)}return l}function C(r){let l=!1;const n=c=>{for(let s=1;s<=9;s++){const o=c.filter(t=>!t.value&&t.candidates.includes(s));o.length===1&&(o[0].value=s,o[0].candidates=[],w(r,o[0].r,o[0].c,s),l=!0)}};for(let c=0;c<9;c++)n(r[c]),n(r.map(s=>s[c]));for(let c=0;c<9;c+=3)for(let s=0;s<9;s+=3){const o=[];for(let t=c;t<c+3;t++)for(let e=s;e<s+3;e++)o.push(r[t][e]);n(o)}return l}function P(r){let l=!1;const n=c=>{const s={};c.forEach(o=>{if(!o.value&&o.candidates.length===2){const t=o.candidates.join(",");s[t]=(s[t]||0)+1}});for(const o in s)if(s[o]===2){const t=o.split(",").map(Number);c.forEach(e=>{!e.value&&e.candidates.join(",")!==o&&t.forEach(i=>{e.candidates.includes(i)&&v(e,i)&&(l=!0)})})}};for(let c=0;c<9;c++)n(r[c]),n(r.map(s=>s[c]));for(let c=0;c<9;c+=3)for(let s=0;s<9;s+=3){const o=[];for(let t=c;t<c+3;t++)for(let e=s;e<s+3;e++)o.push(r[t][e]);n(o)}return l}function R(r){let l=!1;const n=c=>{const s=[];c.forEach(o=>{!o.value&&o.candidates.length>=2&&o.candidates.length<=3&&s.push(o)});for(let o=0;o<s.length;o++)for(let t=o+1;t<s.length;t++)for(let e=t+1;e<s.length;e++){const i=new Set([...s[o].candidates,...s[t].candidates,...s[e].candidates]);if(i.size===3){const a=[...i];c.forEach(u=>{u!==s[o]&&u!==s[t]&&u!==s[e]&&!u.value&&a.forEach(f=>{v(u,f)&&(l=!0)})})}}};for(let c=0;c<9;c++)n(r[c]),n(r.map(s=>s[c]));for(let c=0;c<9;c+=3)for(let s=0;s<9;s+=3){const o=[];for(let t=c;t<c+3;t++)for(let e=s;e<s+3;e++)o.push(r[t][e]);n(o)}return l}function H(r){let l=!1;for(let n=0;n<9;n+=3)for(let c=0;c<9;c+=3)for(let s=1;s<=9;s++){const o=[];for(let t=n;t<n+3;t++)for(let e=c;e<c+3;e++)!r[t][e].value&&r[t][e].candidates.includes(s)&&o.push({r:t,c:e});if(o.length===2||o.length===3){const t=o.every(i=>i.r===o[0].r),e=o.every(i=>i.c===o[0].c);if(t){const i=o[0].r;for(let a=0;a<9;a++)(a<c||a>=c+3)&&v(r[i][a],s)&&(l=!0)}if(e){const i=o[0].c;for(let a=0;a<9;a++)(a<n||a>=n+3)&&v(r[a][i],s)&&(l=!0)}}}return l}function x(r){let l=!1;for(let n=0;n<9;n++)for(let c=1;c<=9;c++){const s=[];for(let a=0;a<9;a++){const u=r[n][a];!u.value&&u.candidates.includes(c)&&s.push(u)}if(s.length<2)continue;const o=new Set(s.map(a=>Math.floor(a.c/3)));if(o.size!==1)continue;const t=[...o][0],e=Math.floor(n/3)*3,i=t*3;for(let a=e;a<e+3;a++)if(a!==n)for(let u=i;u<i+3;u++)v(r[a][u],c)&&(l=!0)}for(let n=0;n<9;n++)for(let c=1;c<=9;c++){const s=[];for(let a=0;a<9;a++){const u=r[a][n];!u.value&&u.candidates.includes(c)&&s.push(u)}if(s.length<2)continue;const o=new Set(s.map(a=>Math.floor(a.r/3)));if(o.size!==1)continue;const e=[...o][0]*3,i=Math.floor(n/3)*3;for(let a=e;a<e+3;a++)for(let u=i;u<i+3;u++)u!==n&&v(r[a][u],c)&&(l=!0)}return l}function X(r){let l=!1;for(let n=1;n<=9;n++){const c=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[o][e];!i.value&&i.candidates.includes(n)&&t.push(e)}t.length===2&&c.push({r:o,cols:t})}for(let o=0;o<c.length;o++)for(let t=o+1;t<c.length;t++){const e=c[o],i=c[t];if(e.cols[0]===i.cols[0]&&e.cols[1]===i.cols[1]){const a=e.cols[0],u=e.cols[1];for(let f=0;f<9;f++)f!==e.r&&f!==i.r&&(v(r[f][a],n)&&(l=!0),v(r[f][u],n)&&(l=!0))}}const s=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[e][o];!i.value&&i.candidates.includes(n)&&t.push(e)}t.length===2&&s.push({c:o,rows:t})}for(let o=0;o<s.length;o++)for(let t=o+1;t<s.length;t++){const e=s[o],i=s[t];if(e.rows[0]===i.rows[0]&&e.rows[1]===i.rows[1]){const a=e.rows[0],u=e.rows[1];for(let f=0;f<9;f++)f!==e.c&&f!==i.c&&(v(r[a][f],n)&&(l=!0),v(r[u][f],n)&&(l=!0))}}}return l}function j(r){let l=!1;for(let n=1;n<=9;n++){const c=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[o][e];!i.value&&i.candidates.includes(n)&&t.push({r:o,c:e})}t.length===2&&c.push(t)}const s=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[e][o];!i.value&&i.candidates.includes(n)&&t.push({r:e,c:o})}t.length===2&&s.push(t)}c.forEach(([o,t])=>{s.forEach(([e,i])=>{if(!(o.r===e.r&&o.c===e.c&&t.c!==i.c||o.r===i.r&&o.c===i.c&&t.c!==e.c||t.r===e.r&&t.c===e.c&&o.c!==i.c||t.r===i.r&&t.c===i.c&&o.c!==e.c))return;const u=o.r===e.r&&o.c===e.c?t:o,f=e.r===o.r&&e.c===o.c?i:e;for(let h=0;h<9;h++)for(let d=0;d<9;d++){const g=r[h][d];if(g.value||!g.candidates.includes(n))continue;const k=h===u.r||d===u.c||Math.floor(h/3)===Math.floor(u.r/3),S=h===f.r||d===f.c||Math.floor(d/3)===Math.floor(f.c/3);k&&S&&v(g,n)&&(l=!0)}})})}return l}function K(r){let l=!1;for(let n=1;n<=9;n++){const c=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[o][e];!i.value&&i.candidates.includes(n)&&t.push(e)}t.length===2&&c.push({r:o,cols:t})}for(let o=0;o<c.length;o++)for(let t=o+1;t<c.length;t++){const e=c[o],i=c[t],a=e.cols.filter(d=>i.cols.includes(d));if(a.length!==1)continue;const u=a[0],f=e.cols.find(d=>d!==u),h=i.cols.find(d=>d!==u);for(let d=0;d<9;d++)for(let g=0;g<9;g++){const k=r[d][g];if(k.value||!k.candidates.includes(n))continue;const S=d===e.r||g===f||Math.floor(d/3)===Math.floor(e.r/3),m=d===i.r||g===h||Math.floor(d/3)===Math.floor(i.r/3);S&&m&&v(k,n)&&(l=!0)}}const s=[];for(let o=0;o<9;o++){const t=[];for(let e=0;e<9;e++){const i=r[e][o];!i.value&&i.candidates.includes(n)&&t.push(e)}t.length===2&&s.push({c:o,rows:t})}for(let o=0;o<s.length;o++)for(let t=o+1;t<s.length;t++){const e=s[o],i=s[t],a=e.rows.filter(d=>i.rows.includes(d));if(a.length!==1)continue;const u=a[0],f=e.rows.find(d=>d!==u),h=i.rows.find(d=>d!==u);for(let d=0;d<9;d++)for(let g=0;g<9;g++){const k=r[d][g];if(k.value||!k.candidates.includes(n))continue;const S=d===f||g===e.c||Math.floor(g/3)===Math.floor(e.c/3),m=d===h||g===i.c||Math.floor(g/3)===Math.floor(i.c/3);S&&m&&v(k,n)&&(l=!0)}}}return l}function z(r){let l=!1;const n=[];for(let s=0;s<9;s++)for(let o=0;o<9;o++){const t=r[s][o];!t.value&&t.candidates.length===2&&n.push({r:s,c:o,nums:[...t.candidates]})}for(let s=0;s<n.length;s++)for(let o=s+1;o<n.length;o++){const t=n[s],e=n[o];if(t.nums[0]!==e.nums[0]||t.nums[1]!==e.nums[1])continue;const i=t.r===e.r,a=t.c===e.c,u=Math.floor(t.r/3)===Math.floor(e.r/3)&&Math.floor(t.c/3)===Math.floor(e.c/3);if(i||a||u)continue;const[f,h]=t.nums;[f,h].forEach(d=>{for(let m=0;m<9;m++){const p=[];for(let y=0;y<9;y++)!r[m][y].value&&r[m][y].candidates.includes(d)&&p.push({r:m,c:y});p.length===2&&(p[0].r===t.r&&p[0].c===t.c&&p[1].r===e.r&&p[1].c===e.c||p[1].r===t.r&&p[1].c===t.c&&p[0].r===e.r&&p[0].c===e.c)&&c(r,t,e,f,h,d)}for(let m=0;m<9;m++){const p=[];for(let y=0;y<9;y++)!r[y][m].value&&r[y][m].candidates.includes(d)&&p.push({r:y,c:m});p.length===2&&(p[0].r===t.r&&p[0].c===t.c&&p[1].r===e.r&&p[1].c===e.c||p[1].r===t.r&&p[1].c===t.c&&p[0].r===e.r&&p[0].c===e.c)&&c(r,t,e,f,h,d)}const g=Math.floor(t.r/3)*3,k=Math.floor(t.c/3)*3,S=[];for(let m=g;m<g+3;m++)for(let p=k;p<k+3;p++)!r[m][p].value&&r[m][p].candidates.includes(d)&&S.push({r:m,c:p});S.length===2&&(S[0].r===t.r&&S[0].c===t.c&&S[1].r===e.r&&S[1].c===e.c||S[1].r===t.r&&S[1].c===t.c&&S[0].r===e.r&&S[0].c===e.c)&&c(r,t,e,f,h,d)})}function c(s,o,t,e,i,a){const u=a===e?i:e;for(let f=0;f<9;f++)for(let h=0;h<9;h++){const d=s[f][h];if(d.value||!d.candidates.includes(u))continue;const g=f===o.r||h===o.c||Math.floor(f/3)===Math.floor(o.r/3),k=f===t.r||h===t.c||Math.floor(f/3)===Math.floor(t.r/3);g&&k&&v(d,u)&&(l=!0)}}return l}function E(r){const l=N(r),n={NakedSingle:0,HiddenSingle:0,NakedPair:0,NakedTriple:0,Pointing:0,Claiming:0,XWing:0,TwoStringKite:0,Skyscraper:0,WWing:0};let c=0;const s=500;for(;c++<s;){let f=!1;if(A(l)?(n.NakedSingle++,f=!0):C(l)?(n.HiddenSingle++,f=!0):P(l)?(n.NakedPair++,f=!0):R(l)?(n.NakedTriple++,f=!0):H(l)?(n.Pointing++,f=!0):x(l)?(n.Claiming++,f=!0):X(l)?(n.XWing++,f=!0):j(l)?(n.TwoStringKite++,f=!0):K(l)?(n.Skyscraper++,f=!0):z(l)&&(n.WWing++,f=!0),!f)break}const o=["NakedSingle","HiddenSingle","NakedPair","NakedTriple","Pointing","Claiming","XWing","TwoStringKite","Skyscraper","WWing"];let t=null;for(let f=o.length-1;f>=0;f--)if(n[o[f]]){t=o[f];break}function e(f){let h=0;for(const d in f)h+=f[d]*(T[d]||0);return Number(h.toFixed(2))}const i=l.every(f=>f.every(h=>h.value));let a=!1,u=null;if(!i){const f=l.some(d=>d.some(g=>!g.value));l.some(d=>d.some(g=>!g.value&&g.candidates.length===0))?(a=!0,u="contradiction"):f&&(a=!0,u="noMoreLogicalMoves")}return{solved:i,stalled:a,stallReason:u,techniquesUsed:n,maxTechnique:t,score:e(n)}}const _={easy:[36,44],medium:[44,52],hard:[50,56],veryHard:[52,60]};function I(r,l){return Math.floor(Math.random()*(l-r+1))+r}function q(r){for(let l=0;l<9;l++)for(let n=0;n<9;n++)if(r[l][n]===null){const c=U([1,2,3,4,5,6,7,8,9]);for(let s of c)if(W(r,l,n,s)){if(r[l][n]=s,q(r))return!0;r[l][n]=null}return!1}return!0}function L(r,l=2){let n=0,c=0;const s=2e4;function o(t){if(++c>s){n=l;return}if(!(n>=l)){for(let e=0;e<9;e++)for(let i=0;i<9;i++)if(t[e][i]===null){for(let a=1;a<=9;a++)W(t,e,i,a)&&(t[e][i]=a,o(t),t[e][i]=null);return}n++}}return o(M(r)),n}function F(r,l){const n=E(M(r));if(!n.solved&&n.stalled)return"fail";const c=n.techniquesUsed.NakedSingle+n.techniquesUsed.HiddenSingle,s=n.techniquesUsed.XWing+n.techniquesUsed.TwoStringKite+n.techniquesUsed.Skyscraper+n.techniquesUsed.WWing>0;return l==="easy"&&n.techniquesUsed.NakedPair+n.techniquesUsed.NakedTriple+n.techniquesUsed.Pointing+n.techniquesUsed.Claiming+n.techniquesUsed.XWing+n.techniquesUsed.TwoStringKite+n.techniquesUsed.Skyscraper+n.techniquesUsed.WWing>0?"tooHard":l==="medium"&&c>30||l==="hard"&&c>20||l==="veryHard"&&(c>15||!s&&c>10)?"tooEasy":"ok"}function D(r){return r.techniquesUsed.XWing+r.techniquesUsed.TwoStringKite+r.techniquesUsed.Skyscraper+r.techniquesUsed.WWing>0}function G(r){const l=M(r);return E(l)}function O(r){let l=0;const n=r==="veryHard"?300:200,c=performance.now();for(;l<n;){l++;const s=Array.from({length:9},()=>Array(9).fill(null)),o=Array.from({length:9},()=>Array(9).fill(null)),t=$({board:s,solution:o,difficulty:r}),e=G(s);if(Z(e,r)){if(r==="veryHard"&&e.techniquesUsed.NakedPair+e.techniquesUsed.NakedTriple+e.techniquesUsed.Pointing+e.techniquesUsed.Claiming+e.techniquesUsed.XWing+e.techniquesUsed.TwoStringKite+e.techniquesUsed.Skyscraper+e.techniquesUsed.WWing<2)continue;const i=performance.now();return console.log(`${r} 생성 시간 : `,((i-c)/1e3).toFixed(3),"s, 시도 횟수 : ",l," 빈칸 수 : ",t),console.log("퍼즐 생성 성공",e),{puzzle:s,solution:o}}else{const i=performance.now();console.log(`${r} 생성 시간 : `,((i-c)/1e3).toFixed(3),"s, 시도 횟수 : ",l," 빈칸 수 : ",t),console.log("퍼즐 생성 난이도 조절",e)}}if(l>=200){const s=performance.now();return console.log(`${r} 생성 시간 : `,((s-c)/1e3).toFixed(3),"s"),console.log("퍼즐 생성 실패 → fallback"),null}}function $({board:r,solution:l,difficulty:n}){q(r);const[c,s]=_[n],o=I(c,s);for(let a=0;a<9;a++)for(let u=0;u<9;u++)l[a][u]=r[a][u];const t=U([...Array(81).keys()]);let e=0,i=0;for(let a of t){const u=Math.floor(a/9),f=a%9;if(r[u][f]===null)continue;const h=r[u][f];if(r[u][f]=null,L(r)!==1){r[u][f]=h;continue}const d=F(r,n);if(d==="fail"){r[u][f]=h,i++;continue}if(d==="tooHard"){r[u][f]=h,i++;continue}if(e++,e>=o){if(n==="veryHard"){const g=E(M(r));if(!D(g))continue}break}if(i>30)break}return e}function Z(r,l){if(!r.solved)return!1;const n=r.score;switch(l){case"easy":return n<1.5;case"medium":return n>=1.5&&n<3.5;case"hard":return n>=3.5&&n<6;case"veryHard":return n>=6;default:return!1}}self.onmessage=r=>{const{type:l,difficulty:n}=r.data;try{if(l==="GENERATE"){const c=O(n);self.postMessage({type:"RESULT",result:c})}}catch(c){self.postMessage({type:"ERROR",error:c?.message??"generator error"})}}})();
