(function(){"use strict";function d(t){for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return t}function g(t){return t.map(n=>n.slice())}function h(t,n,e,r){for(let l=0;l<9;l++)if(t[n][l]===r||t[l][e]===r)return!1;const o=Math.floor(n/3)*3,i=Math.floor(e/3)*3;for(let l=o;l<o+3;l++)for(let f=i;f<i+3;f++)if(t[l][f]===r)return!1;return!0}function m(t,n,e){return{value:t,candidates:t?[]:[1,2,3,4,5,6,7,8,9],r:n,c:e}}function y(t){const n=t.map((e,r)=>e.map((o,i)=>m(o,r,i)));for(let e=0;e<9;e++)for(let r=0;r<9;r++)n[e][r].value&&u(n,e,r,n[e][r].value);return n}function s(t,n){const e=t.candidates.indexOf(n);return e!==-1?(t.candidates.splice(e,1),!0):!1}function u(t,n,e,r){for(let l=0;l<9;l++)l!==e&&s(t[n][l],r),l!==n&&s(t[l][e],r);const o=Math.floor(n/3)*3,i=Math.floor(e/3)*3;for(let l=o;l<o+3;l++)for(let f=i;f<i+3;f++)(l!==n||f!==e)&&s(t[l][f],r)}function v(t){let n=!1;for(let e=0;e<9;e++)for(let r=0;r<9;r++){const o=t[e][r];!o.value&&o.candidates.length===1&&(o.value=o.candidates[0],o.candidates=[],u(t,e,r,o.value),n=!0)}return n}function k(t){let n=!1;const e=r=>{for(let o=1;o<=9;o++){const i=r.filter(l=>!l.value&&l.candidates.includes(o));i.length===1&&(i[0].value=o,i[0].candidates=[],u(t,i[0].r,i[0].c,o),n=!0)}};for(let r=0;r<9;r++)e(t[r]),e(t.map(o=>o[r]));for(let r=0;r<9;r+=3)for(let o=0;o<9;o+=3){const i=[];for(let l=r;l<r+3;l++)for(let f=o;f<o+3;f++)i.push(t[l][f]);e(i)}return n}function S(t){let n=!1;const e=r=>{const o={};r.forEach(i=>{if(!i.value&&i.candidates.length===2){const l=i.candidates.join(",");o[l]=(o[l]||0)+1}});for(const i in o)if(o[i]===2){const l=i.split(",").map(Number);r.forEach(f=>{!f.value&&f.candidates.join(",")!==i&&l.forEach(a=>{f.candidates.includes(a)&&s(f,a)&&(n=!0)})})}};for(let r=0;r<9;r++)e(t[r]),e(t.map(o=>o[r]));for(let r=0;r<9;r+=3)for(let o=0;o<9;o+=3){const i=[];for(let l=r;l<r+3;l++)for(let f=o;f<o+3;f++)i.push(t[l][f]);e(i)}return n}function P(t){let n=!1;for(let e=0;e<9;e+=3)for(let r=0;r<9;r+=3)for(let o=1;o<=9;o++){const i=[];for(let l=e;l<e+3;l++)for(let f=r;f<r+3;f++)!t[l][f].value&&t[l][f].candidates.includes(o)&&i.push({r:l,c:f});if(i.length>1){const l=i.every(a=>a.r===i[0].r),f=i.every(a=>a.c===i[0].c);if(l){const a=i[0].r;for(let c=0;c<9;c++)(c<r||c>=r+3)&&(s(t[a][c],o),n=!0)}if(f){const a=i[0].c;for(let c=0;c<9;c++)(c<e||c>=e+3)&&(s(t[c][a],o),n=!0)}}}return n}function M(t){let n=!1;for(let e=0;e<9;e++)for(let r=1;r<=9;r++){const o=t[e].filter(a=>!a.value&&a.candidates.includes(r));if(o.length<2)continue;const i=Math.floor(o[0].c/3);if(!o.every(a=>Math.floor(a.c/3)===i))continue;const l=Math.floor(e/3)*3,f=i*3;for(let a=l;a<l+3;a++)if(a!==e)for(let c=f;c<f+3;c++)s(t[a][c],r)&&(n=!0)}return n}function N(t){return t.map(n=>n.map(e=>`${e.value??0}:${e.candidates.join("")}`).join("|")).join(`
`)}function B(t){const n=y(t),e={NakedSingle:!1,HiddenSingle:!1,NakedPair:!1,Pointing:!1,Claiming:!1};let r="";for(;;){const f=N(n);if(f===r)break;if(r=f,v(n)){e.NakedSingle=!0;continue}if(k(n)){e.HiddenSingle=!0;continue}if(S(n)){e.NakedPair=!0;continue}if(P(n)){e.Pointing=!0;continue}if(M(n)){e.Claiming=!0;continue}break}const o=["NakedSingle","HiddenSingle","NakedPair","Pointing","Claiming"];let i=null;for(let f=o.length-1;f>=0;f--)if(e[o[f]]){i=o[f];break}return{solved:n.every(f=>f.every(a=>a.value)),techniquesUsed:e,maxTechnique:i}}function z(t){switch(t){case"easy":return 30;case"medium":return 40;case"hard":return 50;case"expert":return 60;default:return 40}}function p(t){for(let n=0;n<9;n++)for(let e=0;e<9;e++)if(t[n][e]===null){const r=d([1,2,3,4,5,6,7,8,9]);for(let o of r)if(h(t,n,e,o)){if(t[n][e]=o,p(t))return!0;t[n][e]=null}return!1}return!0}function C(t,n=2){let e=0,r=0;const o=2e4;function i(l){if(++r>o){e=n;return}if(!(e>=n)){for(let f=0;f<9;f++)for(let a=0;a<9;a++)if(l[f][a]===null){for(let c=1;c<=9;c++)h(l,f,a,c)&&(l[f][a]=c,i(l),l[f][a]=null);return}e++}}return i(g(t)),e}function x({board:t,solution:n,empty:e}){p(t),console.log("generatePuzzle");for(let i=0;i<9;i++)for(let l=0;l<9;l++)n[i][l]=t[i][l];const r=d([...Array(81).keys()]);let o=0;for(let i of r){if(console.log("generatePuzzle for",o,e),e<=0||o>100)break;o++;const l=Math.floor(i/9),f=i%9,a=t[l][f];t[l][f]=null,C(t)!==1?t[l][f]=a:e--}}function j(t){const n=g(t);return B(n)}function A(t,n){if(!t.solved)return!1;const e=t.maxTechnique;switch(n){case"easy":return e==="NakedSingle";case"medium":return e==="HiddenSingle";case"hard":return e==="NakedPair"||e==="Pointing";case"expert":return e==="Claiming";default:return!1}}function E(t){let n=0;for(console.log("generateByLogic",n);n<200;){console.log("while",n),n++;const e=Array.from({length:9},()=>Array(9).fill(null)),r=Array.from({length:9},()=>Array(9).fill(null)),o=z(t);x({board:e,solution:r,empty:o});const i=j(e);if(A(i,t))return console.log("퍼즐 생성 성공",i),{puzzle:e,solution:r};console.log("tries",n)}if(n>=200)return console.warn("퍼즐 생성 실패 → fallback"),null}self.onmessage=t=>{const{difficulty:n}=t.data;try{const e=E(n);self.postMessage({ok:!0,result:e})}catch(e){self.postMessage({ok:!1,error:e?.message??"generator error"})}}})();
